<!doctype html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <title>PokeMarket - Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- CSS global compartido -->
  <link rel="stylesheet" href="CSS/style.css">
</head>

<body class="bg-pokeballs">

  <!-- NAVBAR PRINCIPAL INDEX -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
    <div class="container d-flex align-items-center justify-content-between">

      <!-- Lado izquierdo: logo + nombre + botón colección -->
      <div class="d-flex align-items-center gap-3">
        <a class="navbar-brand d-flex align-items-center gap-2 mb-0" href="Home.html">
          <img src="img/Masterball.png" alt="Masterball" style="width: 32px; height: 32px;">
          <span class="brand-text">PokeMarket</span>
        </a>
        <a href="Pages/Colección.html"
          class="btn btn-sm btn-outline-light d-none d-md-inline-flex align-items-center gap-1">
          <i class="bi bi-collection"></i>
          <span>Colección</span>
        </a>
      </div>

      <!-- Lado derecho: créditos + tema + perfil -->
      <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end">

        <!-- Créditos globales: solo icono + número -->
        <div class="d-flex align-items-center gap-1" id="globalCredits">
          <i class="bi bi-coin text-warning"></i>
          <span class="fw-bold">0</span>
        </div>



        <!-- Dropdown perfil -->
        <div class="dropdown">
          <button class="btn btn-outline-light rounded-pill d-flex align-items-center" type="button" id="profileDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
            <img src="img/avatars/pokeball.png" alt="Avatar" class="rounded-circle border me-2" id="navbarAvatar" width="28" height="28" style="object-fit:cover;">
            <span class="d-none d-sm-inline user-name" id="navbarUserName">
              Entrenador
            </span>
            <i class="bi bi-caret-down-fill ms-1 small d-none d-sm-inline"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown">
            <li class="px-3 py-2">
              <div class="d-flex align-items-center">
                <img src="img/avatars/pokeball.png" alt="Avatar" class="rounded-circle border me-2" id="dropdownAvatar" width="36" height="36" style="object-fit:cover;">
                <div class="min-w-0">
                  <div class="fw-semibold small text-truncate" id="dropdownUserName">Entrenador</div>
                  <div class="text-muted xsmall text-truncate" id="dropdownUserEmail">
                    entrenador@pokemarket.com
                  </div>
                </div>
              </div>
            </li>
            <li>
              <hr class="dropdown-divider my-1">
            </li>
            <li>
              <a class="dropdown-item small" href="Pages/Perfil.html">
                <i class="bi bi-person-badge me-2"></i>Ver perfil
              </a>
            </li>
            <li>
              <a class="dropdown-item small" href="Pages/InicioSesion.html" id="logoutLink">
                <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
              </a>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </nav>

  <main class="py-4">
    <div class="container">

      <!-- SECCIÓN RULETA PRINCIPAL -->
      <section class="mb-4">
        <header class="text-center mb-3 roulette-header bg-transparent">
          <p class="text-uppercase xsmall text-muted mb-1">Casino de cartas</p>
          <h1 class="h3 fw-bold mb-1">Ruletas Insanas de PokeMarket</h1>
          <p class="small text-muted mb-0">
            Gira la ruleta, sube de rareza y convierte tus
            <span class="text-warning fw-semibold"><i class="bi bi-coin text-warning"></i> monedas</span>
            en cartas absurdamente buenas.
          </p>
        </header>

        <!-- Botón comprar créditos -->
        <div class="d-flex justify-content-center mb-3">
          <button type="button" class="btn btn-warning btn-lg fw-semibold rounded-pill" data-bs-toggle="modal" data-bs-target="#creditShopModal">
            <i class="bi bi-plus-circle-fill me-2"></i>Comprar monedas
          </button>
        </div>

        <!-- Selector de ruletas -->
        <section class="roulette-selector mb-4">
          <div class="row g-3">
            <!-- Común -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card active" data-wheel="common">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">Básica</span></div>
                <h2 class="h6 mb-1">Ruleta Común</h2>
                <p class="xsmall mb-2 text-muted">Solo cartas hasta Rara. Perfecta para farmear barato.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Común–Rara</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    20
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>20</span>
                  </span>
                  <span class="badge bg-secondary-subtle text-secondary-emphasis xsmall">Baja inversión</span>
                </div>
              </article>
            </div>

            <!-- Intermedia -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card" data-wheel="mid">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">Progresión</span></div>
                <h2 class="h6 mb-1">Ruleta Intermedia</h2>
                <p class="xsmall mb-2 text-muted">Mezcla de cartas hasta Super rara.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Común–Super rara</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    40
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>40</span>
                  </span>
                  <span class="badge bg-info-subtle text-info-emphasis xsmall">Mejor media</span>
                </div>
              </article>
            </div>

            <!-- Avanzada -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card" data-wheel="advanced">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">Plus</span></div>
                <h2 class="h6 mb-1">Ruleta Avanzada</h2>
                <p class="xsmall mb-2 text-muted">Infrecuente a Élite. Menos morralla.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Infrecuente–Élite</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    80
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>80</span>
                  </span>
                  <span class="badge bg-primary-subtle text-primary-emphasis xsmall">Valor constante</span>
                </div>
              </article>
            </div>

            <!-- Experta -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card" data-wheel="expert">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">High roll</span></div>
                <h2 class="h6 mb-1">Ruleta Experta</h2>
                <p class="xsmall mb-2 text-muted">Rara a Épica. Buscando cartas fuertes.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Rara–Épica</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    120
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>120</span>
                  </span>
                  <span class="badge bg-warning-subtle text-warning-emphasis xsmall">High risk</span>
                </div>
              </article>
            </div>

            <!-- Mítica -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card" data-wheel="mythic">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">Endgame</span></div>
                <h2 class="h6 mb-1">Ruleta Mítica</h2>
                <p class="xsmall mb-2 text-muted">Super rara a Mítica/Legendaria.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Super rara–Legendaria</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    200
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>200</span>
                  </span>
                  <span class="badge bg-danger-subtle text-danger-emphasis xsmall">Muy volátil</span>
                </div>
              </article>
            </div>

            <!-- Legendaria -->
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card p-3 h-100 rounded-3 roulette-choice-card legendary" data-wheel="legendary">
                <div class="mb-2"><span class="badge bg-secondary text-muted small">Insana</span></div>
                <h2 class="h6 mb-1">Ruleta Legendaria</h2>
                <p class="xsmall mb-2 text-muted">Élite a Legendaria. Más probabilidad de oro.</p>
                <ul class="list-unstyled ps-0 xsmall mb-2" style="margin-bottom: 0.35rem;">
                  <li><span class="text-muted">•</span> Rangos: Élite–Legendaria</li>
                  <li>
                    <span class="text-muted">•</span> Coste:
                    <i class="bi bi-coin text-warning"></i>
                    400
                  </li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning d-flex align-items-center gap-1">
                    <i class="bi bi-coin text-warning small"></i>
                    <span>400</span>
                  </span>
                  <span class="badge bg-warning-subtle text-warning-emphasis xsmall">Solo valientes</span>
                </div>
              </article>
            </div>
          </div>
        </section>

        <!-- RULETA + panel derecha -->
        <div class="row g-4 align-items-start">

          <!-- RULETA -->
          <div class="col-lg-8">
            <section class="roulette-card card border-0 shadow-lg rounded-4">
              <div class="card-header border-0 roulette-card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-danger-subtle text-danger-emphasis xsmall me-2">
                      <i class="bi bi-lightning-charge-fill me-1"></i>Ruleta activa
                    </span>
                    <span class="badge bg-warning-subtle text-warning-emphasis xsmall">
                      Boost x1.5 en épicas y superiores
                    </span>
                  </div>
                  <div class="text-end">
                    <span class="xsmall text-muted d-block">Balance</span>
                    <span class="small fw-semibold text-success d-flex align-items-center justify-content-end gap-1"
                      id="balanceCredits">
                      <i class="bi bi-coin text-warning small"></i>
                      <span>0</span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="card-body roulette-body">
                <!-- Rarezas -->
                <div class="roulette-rarities d-flex flex-wrap justify-content-between align-items-center mb-3">
                  <div class="rarity-pill rarity-1 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Común</div>
                  <div class="rarity-pill rarity-2 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Infrecuente</div>
                  <div class="rarity-pill rarity-3 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Rara</div>
                  <div class="rarity-pill rarity-4 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Super rara</div>
                  <div class="rarity-pill rarity-5 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Élite</div>
                  <div class="rarity-pill rarity-6 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Épica</div>
                  <div class="rarity-pill rarity-7 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Mítica</div>
                  <div class="rarity-pill rarity-8 d-inline-flex align-items-center gap-2 px-2 py-1"><span class="rarity-color-dot"></span>Legendaria</div>
                </div>

                <!-- Ventana ruleta -->
                <div class="roulette-window-wrapper mb-3">
                  <div class="roulette-highlight"></div>
                  <div class="roulette-window">
                    <div class="roulette-strip d-flex gap-1 p-1" id="rouletteStrip"></div>
                  </div>
                  <div class="roulette-bottom-glow"></div>
                </div>

                <!-- Resultado -->
                <div class="roulette-result text-center mb-3" id="rouletteResult">
                  <span class="small text-info">
                    <i class="bi bi-dice-5 me-1"></i>Cargando cartas TCG...
                  </span>
                </div>

                <!-- Controles -->
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="d-flex align-items-center gap-1">
                      <span class="xsmall text-muted">Auto giros:</span>
                      <select class="form-select form-select-sm roulette-autospins-select" id="autoCount">
                        <option value="5">5 giros</option>
                        <option value="10" selected>10 giros</option>
                        <option value="15">15 giros</option>
                        <option value="20">20 giros</option>
                        <option value="25">25 giros</option>
                        <option value="30">30 giros (MAX)</option>
                      </select>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" type="button" id="btnAuto" disabled>
                        <i class="bi bi-arrow-repeat me-1"></i>Auto giros
                      </button>
                      <button class="btn btn-outline-danger btn-sm d-none" type="button" id="btnStopAuto">
                        <i class="bi bi-stop-circle me-1"></i>Parar
                      </button>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="xsmall text-muted mb-1 d-flex align-items-center justify-content-end gap-1">
                      <span>Coste por giro:</span>
                      <span class="text-warning fw-semibold d-flex align-items-center gap-1" id="spinCost">
                        <i class="bi bi-coin text-warning small"></i>
                        <span>20</span>
                      </span>
                    </div>
                      <button class="btn btn-warning btn-lg fw-semibold rounded-pill" id="btnSpin" disabled>
                        <i class="bi bi-dice-5 me-1"></i>Girar 1 vez
                      </button>
                  </div>
                </div>
              </div>

              <div class="card-footer border-0 roulette-footer xsmall text-muted">
                Los objetos ganados se añaden automáticamente a tu colección. Puedes gestionarlos desde la página de
                <a href="Pages/Colección.html" class="text-warning text-decoration-none fw-semibold">Colección</a>.
              </div>
            </section>
          </div>

          <!-- PANEL DERECHA -->
          <div class="col-lg-4">
            <section class="card border-0 shadow-sm rounded-4 mb-3">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-graph-up-arrow me-1"></i>Probabilidades base</h2>
                <ul class="list-unstyled mb-0 xsmall" id="baseProbList"></ul>
              </div>
            </section>

            <section class="card border-0 shadow-sm rounded-4 mb-3">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-activity me-1"></i>Tendencia de tus giros</h2>
                <p class="xsmall text-muted">Basado en las últimas sesiones de ruleta.</p>
                <ul class="list-unstyled mb-0 xsmall" id="currentProbList"></ul>
              </div>
            </section>

            <section class="card border-0 shadow-sm rounded-4">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-trophy-fill text-warning me-1"></i>Últimos drops épicos
                </h2>
                <ul class="list-unstyled mb-0 xsmall" id="lastDrops"></ul>
              </div>
            </section>
          </div>
        </div>
      </section>

      <!-- SECCIÓN TIENDA RÁPIDA -->
      <hr class="my-5">

      <section class="mb-4">
        <header class="d-flex flex-wrap justify-content-between align-items-center mb-2 bg-transparent">
          <div>
            <p class="text-uppercase xsmall text-muted mb-1">Mercado instantáneo</p>
            <h2 class="h4 fw-semibold mb-1">Tienda de Cartas – Picks del Día</h2>
            <p class="xsmall text-muted mb-0">Cartas seleccionadas por rareza, compradas al momento con tus mismas
              monedas.</p>
          </div>
          <!-- Badge créditos tienda: solo icono + número -->
          <span class="badge bg-dark-subtle text-light-emphasis xsmall d-flex align-items-center gap-1"
            id="shopCredits">
            <i class="bi bi-coin text-warning small"></i>
            <span>0</span>
          </span>
        </header>
      </section>

      <!-- Cartas diarias -->
      <section class="card border-0 shadow-sm mb-4 tienda-section">
        <div class="card-header border-0 bg-transparent d-flex flex-wrap justify-content-between align-items-center">
          <div>
            <h3 class="h6 mb-1 text-uppercase text-muted xsmall">Selección diaria</h3>
            <h4 class="h5 mb-0 fw-semibold">Cartas destacadas de hoy</h4>
            <p class="xsmall text-muted mb-0">Rotación diaria, stock ilimitado por carta. Caza gangas antes de que
              cambien.</p>
          </div>
          <div class="d-flex flex-column align-items-end gap-1">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-sm btn-outline-success d-flex align-items-center gap-2" id="btnRefreshDaily">
                <i class="bi bi-arrow-clockwise spin"></i>
                <span class="xsmall fw-semibold text-uppercase">Recargar tienda</span>
                <span class="badge bg-dark-subtle text-warning-emphasis xsmall d-flex align-items-center gap-1">
                  <i class="bi bi-coin text-warning"></i>
                  <span id="refreshCostLabel">50</span>
                </span>
              </button>
            </div>
            <div class="text-end xsmall text-muted">
              <span id="dailyResetLabel">Cambio diario a las 00:00</span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3" id="dailyCardsGrid">
            <!-- Plantilla -->
            <div class="col-6 col-md-4 col-lg-3 d-none" id="dailyCardTemplate">
              <article class="card card-carta h-100 tienda-card-dia">
                <div class="card-carta-frame">
                  <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
                    <span class="xsmall text-muted">Imagen carta</span>
                  </div>
                </div>
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <h5 class="small fw-semibold mb-0 text-truncate daily-name">Nombre carta</h5>
                    <span class="badge xsmall daily-rarity">Rara</span>
                  </div>
                  <p class="xsmall text-muted mb-1 text-truncate daily-set">Set</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-1">
                      <i class="bi bi-coin text-warning small"></i>
                      <span class="small fw-semibold daily-price">120</span>
                    </div>
                    <button class="btn btn-warning btn-sm fw-semibold rounded-pill daily-buy-btn tienda-dia-btn-comprar">Comprar</button>
                  </div>
                  <p class="xsmall text-muted mt-1 mb-0 daily-stock">Stock: ∞</p>
                </div>
              </article>
            </div>
            <!-- /plantilla -->
            <p class="text-muted small mb-0" id="dailyEmptyText">Cargando selección diaria...</p>
          </div>
        </div>
      </section>

      <!-- SECCIÓN SOBRES -->
      <section class="card border-0 shadow-sm mb-4 tienda-section">
        <div class="card-header border-0 bg-transparent d-flex flex-wrap justify-content-between align-items-center">
          <div>
            <p class="text-uppercase xsmall text-muted mb-1">Fábrica de dopamina</p>
            <h3 class="h5 mb-1 fw-semibold">Sobres PokeMarket – Abre y reza</h3>
            <p class="xsmall text-muted mb-0">Cada carta del sobre tiene su propia probabilidad según el tipo de sobre.
              Elige tu riesgo y mira qué sale.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-stretch">
            <!-- Lista de sobres -->
            <div class="col-12">
              <div class="row g-3" id="packsGrid">
                <!-- Sobre básico -->
                <div class="col-12 col-md-6 col-xl-3">
                  <article class="card tienda-pack-card h-100" data-pack-id="basic">
                    <div class="card-body d-flex gap-3">
                      <div class="flex-shrink-0 rounded-3 anim-pack-float d-flex align-items-center justify-content-center bg-secondary-subtle" style="width:64px;height:92px;">
                        <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center" style="width:26px;height:26px;font-weight:700;">B</div>
                      </div>
                      <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h5 class="small fw-semibold mb-0">Sobre Básico</h5>
                            <p class="xsmall text-muted mb-1">Entrada chill con dopamina.</p>
                          </div>
                          <button type="button" class="btn btn-link p-0 xsmall text-muted pack-info-btn"
                            data-pack-id="basic">
                            <i class="bi bi-info-circle-fill"></i>
                          </button>
                        </div>
                        <ul class="xsmall text-muted mb-1 ps-3">
                          <li>Probabilidades dinámicas por carta.</li>
                        </ul>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center gap-1">
                            <i class="bi bi-coin text-warning small"></i>
                            <span class="small fw-semibold">60</span>
                          </div>
                          <button class="btn btn-warning btn-sm fw-semibold rounded-pill pack-open-btn" data-pack-id="basic">
                            Abrir sobre
                          </button>
                        </div>
                      </div>
                    </div>
                  </article>
                </div>

                <!-- Sobre competitivo -->
                <div class="col-12 col-md-6 col-xl-3">
                  <article class="card tienda-pack-card h-100" data-pack-id="competitive">
                    <div class="card-body d-flex gap-3">
                      <div class="flex-shrink-0 rounded-3 anim-pack-float d-flex align-items-center justify-content-center bg-secondary-subtle" style="width:64px;height:92px;">
                        <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center" style="width:26px;height:26px;font-weight:700;">C</div>
                      </div>
                      <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h5 class="small fw-semibold mb-0">Sobre Competitivo</h5>
                            <p class="xsmall text-muted mb-1">Más raras y opción épica.</p>
                          </div>
                          <button type="button" class="btn btn-link p-0 xsmall text-muted pack-info-btn"
                            data-pack-id="competitive">
                            <i class="bi bi-info-circle-fill"></i>
                          </button>
                        </div>
                        <ul class="xsmall text-muted mb-1 ps-3">
                          <li>Probabilidades pensadas para ladder.</li>
                        </ul>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center gap-1">
                            <i class="bi bi-coin text-warning small"></i>
                            <span class="small fw-semibold">180</span>
                          </div>
                          <button class="btn btn-warning btn-sm fw-semibold rounded-pill pack-open-btn" data-pack-id="competitive">
                            Abrir sobre
                          </button>
                        </div>
                      </div>
                    </div>
                  </article>
                </div>

                <!-- Sobre fuego -->
                <div class="col-12 col-md-6 col-xl-3">
                  <article class="card tienda-pack-card h-100" data-pack-id="fire">
                    <div class="card-body d-flex gap-3">
                      <div class="flex-shrink-0 rounded-3 anim-pack-float d-flex align-items-center justify-content-center bg-secondary-subtle" style="width:64px;height:92px;">
                        <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center" style="width:26px;height:26px;font-weight:700;">F</div>
                      </div>
                      <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h5 class="small fw-semibold mb-0">Sobre Fuego</h5>
                            <p class="xsmall text-muted mb-1">Épicas y míticas en modo slot machine.</p>
                          </div>
                          <button type="button" class="btn btn-link p-0 xsmall text-muted pack-info-btn"
                            data-pack-id="fire">
                            <i class="bi bi-info-circle-fill"></i>
                          </button>
                        </div>
                        <ul class="xsmall text-muted mb-1 ps-3">
                          <li>Mucha varianza, muchas luces.</li>
                        </ul>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center gap-1">
                            <i class="bi bi-coin text-warning small"></i>
                            <span class="small fw-semibold">480</span>
                          </div>
                          <button class="btn btn-warning btn-sm fw-semibold rounded-pill pack-open-btn" data-pack-id="fire">
                            Abrir sobre
                          </button>
                        </div>
                      </div>
                    </div>
                  </article>
                </div>

                <!-- Sobre grail -->
                <div class="col-12 col-md-6 col-xl-3">
                  <article class="card tienda-pack-card h-100" data-pack-id="grail">
                    <div class="card-body d-flex gap-3">
                      <div class="flex-shrink-0 rounded-3 anim-pack-float d-flex align-items-center justify-content-center bg-secondary-subtle" style="width:64px;height:92px;">
                        <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center" style="width:26px;height:26px;font-weight:700;">G</div>
                      </div>
                      <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h5 class="small fw-semibold mb-0">Sobre Grail</h5>
                            <p class="xsmall text-muted mb-1">Solo enfermos de la dopamina.</p>
                          </div>
                          <button type="button" class="btn btn-link p-0 xsmall text-muted pack-info-btn"
                            data-pack-id="grail">
                            <i class="bi bi-info-circle-fill"></i>
                          </button>
                        </div>
                        <ul class="xsmall text-muted mb-1 ps-3">
                          <li>Donde viven las legendarias.</li>
                        </ul>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center gap-1">
                            <i class="bi bi-coin text-warning small"></i>
                            <span class="small fw-semibold">1200</span>
                          </div>
                          <button class="btn btn-warning btn-sm fw-semibold rounded-pill pack-open-btn" data-pack-id="grail">
                            Abrir sobre
                          </button>
                        </div>
                      </div>
                    </div>
                  </article>
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <p class="roulette-disclaimer text-center mt-4">
        Probabilidades fijas por rareza, ruleta y tipo de sobre. Juega con cabeza y disfruta del vicio controlado.
      </p>

    </div>
  </main>

  <!-- Toast notificaciones -->
  <div class="roulette-toast-container" id="toastContainer"></div>

  <!-- Modal recompensa carta (ruleta) -->
  <div class="modal fade reward-modal" id="rewardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content reward-modal-content">
        <div class="reward-glow"></div>
        <div class="reward-rays"></div>
        <div class="modal-body text-center">
          <p class="xsmall text-muted mb-1">¡Nueva recompensa!</p>
          <h2 class="h5 fw-bold mb-2" id="rewardTitle">Has conseguido una carta</h2>

          <div class="reward-card-wrapper">
            <div class="reward-card-inner">
              <img id="rewardImage" src="" alt="Carta obtenida">
            </div>
          </div>

          <p class="mt-2 mb-1">
            <span class="badge" id="rewardRarityBadge">Épica</span>
          </p>
          <p class="small text-muted mb-0" id="rewardSetName"></p>

          <div class="mt-3 d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" id="rewardContinueBtn">
              Seguir girando
            </button>
            <a href="Pages/Colección.html" class="btn btn-warning btn-sm" id="btnGoCollection">
              Ir a colección
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal compra créditos -->
  <div class="modal fade" id="creditShopModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Comprar monedas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="xsmall text-muted mb-2">
            Selecciona un pack de monedas (simulación).
          </p>
          <div class="list-group small">
            <button type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center credit-buy-btn"
              data-amount="200">
              <span>Pack pequeño</span>
              <span class="fw-semibold d-flex align-items-center gap-1">
                <span>200</span>
                <i class="bi bi-coin text-warning"></i>
              </span>
            </button>
            <button type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center credit-buy-btn"
              data-amount="600">
              <span>Pack medio</span>
              <span class="fw-semibold d-flex align-items-center gap-1">
                <span>600</span>
                <i class="bi bi-coin text-warning"></i>
              </span>
            </button>
            <button type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center credit-buy-btn"
              data-amount="1500">
              <span>Pack dopamina</span>
              <span class="fw-semibold d-flex align-items-center gap-1">
                <span>1500</span>
                <i class="bi bi-coin text-warning"></i>
              </span>
            </button>
          </div>
          <p class="xsmall text-muted mt-2 mb-0">
            En producción aquí iría tu pasarela real.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal info probabilidades sobre -->
  <div class="modal fade" id="packInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title xsmall" id="packInfoTitle">Probabilidades sobre</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-unstyled xsmall mb-0" id="packInfoList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal apertura sobre (animación dopamina) -->
  <div class="modal fade" id="openPackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="openPackTitle">Sobre abierto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Etapa reveal carta a carta -->
          <div id="packRevealStage">
            <div class="pack-reveal-backdrop">
              <div class="pack-reveal-card-slot">
                <!-- carta activa se pinta por JS -->
              </div>
            </div>
            <div class="text-center mt-2">
              <p class="xsmall text-muted mb-1" id="packRevealCounter">
                Carta 1 de 6
              </p>
              <button class="btn btn-warning btn-sm fw-semibold rounded-pill" id="btnNextReveal">
                Ver siguiente carta
              </button>
            </div>
          </div>

          <!-- Resumen final -->
          <div id="packSummaryStage" class="d-none mt-3">
            <h6 class="small fw-semibold mb-2">
              <i class="bi bi-collection me-1"></i>
              Resumen del sobre
            </h6>
            <div class="row g-2" id="packCardsGrid"></div>
          </div>

          <p class="xsmall text-muted mb-0 mt-2">
            Las cartas se han añadido a tu colección.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            Cerrar
          </button>
          <a href="Pages/Colección.html" class="btn btn-warning btn-sm fw-semibold rounded-pill">
            Ver colección
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script principal: tema, usuario, ruleta, tienda, sobres -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {


      const defaultName = 'Entrenador';
      const defaultEmail = 'entrenador@pokemarket.com';
      const defaultAvatar = 'img/avatars/pokeball.png';

      const name = localStorage.getItem('pm_user_name') || defaultName;
      const email = localStorage.getItem('pm_user_email') || defaultEmail;
      const avatar = localStorage.getItem('pm_user_avatar') || defaultAvatar;

      const navbarUserName = document.getElementById('navbarUserName');
      const dropdownUserName = document.getElementById('dropdownUserName');
      const dropdownUserEmail = document.getElementById('dropdownUserEmail');
      const navbarAvatar = document.getElementById('navbarAvatar');
      const dropdownAvatar = document.getElementById('dropdownAvatar');

      if (navbarUserName) navbarUserName.textContent = name;
      if (dropdownUserName) dropdownUserName.textContent = name;
      if (dropdownUserEmail) dropdownUserEmail.textContent = email;
      if (navbarAvatar) navbarAvatar.src = avatar;
      if (dropdownAvatar) dropdownAvatar.src = avatar;

      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', () => {
          localStorage.removeItem('pm_user_name');
          localStorage.removeItem('pm_user_email');
          localStorage.removeItem('pm_user_avatar');
          localStorage.removeItem('pm_user_bio');
          localStorage.removeItem('pm_cards_sale');
          localStorage.removeItem('pm_collection');
          localStorage.removeItem('pm_credits');
        });
      }

      const rarityDefs = [
        { id: 1, key: 'common', label: 'Común' },
        { id: 2, key: 'uncommon', label: 'Infrecuente' },
        { id: 3, key: 'rare', label: 'Rara' },
        { id: 4, key: 'superrare', label: 'Super rara' },
        { id: 5, key: 'elite', label: 'Élite' },
        { id: 6, key: 'epic', label: 'Épica' },
        { id: 7, key: 'mythic', label: 'Mítica' },
        { id: 8, key: 'legendary', label: 'Legendaria' }
      ];

      const wheelsConfig = {
        common: {
          name: 'Ruleta Común',
          cost: 20,
          probs: {
            common: 0.70,
            uncommon: 0.25,
            rare: 0.05
          }
        },
        mid: {
          name: 'Ruleta Intermedia',
          cost: 40,
          probs: {
            common: 0.45,
            uncommon: 0.30,
            rare: 0.15,
            superrare: 0.07,
            elite: 0.03
          }
        },
        advanced: {
          name: 'Ruleta Avanzada',
          cost: 80,
          probs: {
            uncommon: 0.35,
            rare: 0.30,
            superrare: 0.18,
            elite: 0.12,
            epic: 0.05
          }
        },
        expert: {
          name: 'Ruleta Experta',
          cost: 120,
          probs: {
            rare: 0.35,
            superrare: 0.28,
            elite: 0.18,
            epic: 0.12,
            mythic: 0.07
          }
        },
        mythic: {
          name: 'Ruleta Mítica',
          cost: 200,
          probs: {
            superrare: 0.30,
            elite: 0.27,
            epic: 0.20,
            mythic: 0.22,
            legendary: 0.01
          }
        },
        legendary: {
          name: 'Ruleta Legendaria',
          cost: 400,
          probs: {
            elite: 0.38,
            epic: 0.31,
            mythic: 0.28,
            legendary: 0.03
          }
        }
      };

      const packRarityProbs = {
        basic: {
          name: 'Sobre Básico',
          price: 60,
          probs: {
            common: 0.60,
            uncommon: 0.25,
            rare: 0.10,
            superrare: 0.04,
            elite: 0.01
          }
        },
        competitive: {
          name: 'Sobre Competitivo',
          price: 180,
          probs: {
            common: 0.35,
            uncommon: 0.30,
            rare: 0.20,
            superrare: 0.10,
            elite: 0.04,
            epic: 0.01
          }
        },
        fire: {
          name: 'Sobre Fuego',
          price: 480,
          probs: {
            uncommon: 0.20,
            rare: 0.25,
            superrare: 0.20,
            elite: 0.15,
            epic: 0.10,
            mythic: 0.08,
            legendary: 0.02
          }
        },
        grail: {
          name: 'Sobre Grail',
          price: 1200,
          probs: {
            rare: 0.20,
            superrare: 0.20,
            elite: 0.20,
            epic: 0.20,
            mythic: 0.15,
            legendary: 0.05
          }
        }
      };

      const rarityPriceMap = {
        common: 20,
        uncommon: 40,
        rare: 80,
        superrare: 150,
        elite: 260,
        epic: 420,
        mythic: 700,
        legendary: 1200
      };

      const TCG_API_BASE = 'https://api.tcgdex.net/v2/en/cards';

      function fnv1aHash(str) {
        let hash = 2166136261 >>> 0;
        for (let i = 0; i < str.length; i++) {
          hash ^= str.charCodeAt(i);
          hash = Math.imul(hash, 16777619) >>> 0;
        }
        return hash >>> 0;
      }

      function mapApiRarityToInternal(card) {
        const price = card.priceEur ?? null;
        if (price !== null) {
          if (price >= 80) return 'legendary';
          if (price >= 40) return 'mythic';
          if (price >= 20) return 'epic';
          if (price >= 10) return 'elite';
          if (price >= 5) return 'superrare';
          if (price >= 2) return 'rare';
          if (price >= 1) return 'uncommon';
          return 'common';
        }

        const id = String(card.id || '');
        const hash = fnv1aHash(id);
        const r = (hash % 10000) / 10000;

        if (r < 0.5500) return 'common';
        if (r < 0.7500) return 'uncommon';
        if (r < 0.8500) return 'rare';
        if (r < 0.9100) return 'superrare';
        if (r < 0.9500) return 'elite';
        if (r < 0.9800) return 'epic';
        if (r < 0.9950) return 'mythic';
        return 'legendary';
      }

      const cardsByRarity = {
        common: [], uncommon: [], rare: [],
        superrare: [], elite: [], epic: [], mythic: [], legendary: []
      };
      window.cardsByRarity = cardsByRarity;

      async function loadAllCardsFromApi(maxPages = 40) {
        let currentPage = 1;

        while (true) {
          const url = `${TCG_API_BASE}?pagination:page=${currentPage}&pagination:itemsPerPage=50`;
          const res = await fetch(url);
          if (!res.ok) break;

          const cards = await res.json();
          if (!Array.isArray(cards) || !cards.length) break;

          cards.forEach(card => {
            const cm = card.pricing?.cardmarket || {};
            const price =
              cm['avg30-holo'] ??
              cm['avg-holo'] ??
              cm['avg30'] ??
              cm['avg'] ??
              null;

            const mapped = {
              id: card.id,
              name: card.name,
              imageUrl: card.image ? `${card.image}/low.png` : null,
              apiRarity: card.rarity || null,
              priceEur: price,
              setName: card.set?.name || ''
            };

            const internalRarity = mapApiRarityToInternal(mapped);
            if (!cardsByRarity[internalRarity]) return;

            cardsByRarity[internalRarity].push({
              id: mapped.id,
              name: mapped.name,
              image: mapped.imageUrl || '',
              apiRarity: mapped.apiRarity || '',
              setName: mapped.setName || '',
              types: [],
              holographic: false,
              priceEur: mapped.priceEur ?? null,
              priceUsd: null
            });
          });

          currentPage++;
          if (currentPage > maxPages) break;
        }
      }

      function getRandomCardFromRarity(rarityKey) {
        const pool = cardsByRarity[rarityKey] || [];
        if (!pool.length) return null;
        const base = pool[Math.floor(Math.random() * pool.length)];
        return {
          ...base,
          rarityInternal: rarityKey,
          rarity: rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0]
        };
      }

      function getDailySeed() {
        const now = new Date();
        const y = now.getUTCFullYear();
        const m = now.getUTCMonth() + 1;
        const d = now.getUTCDate();
        return `${y}-${m}-${d}`;
      }

      function seededRandom(seed, max) {
        const hash = fnv1aHash(seed);
        return hash % max;
      }

      function pickPackRarity(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg) return rarityDefs[0];
        const entries = Object.entries(cfg.probs);
        const total = entries.reduce((sum, [, p]) => sum + p, 0);
        const r = Math.random() * total;
        let acc = 0;
        for (const [key, p] of entries) {
          acc += p;
          if (r <= acc) {
            return rarityDefs.find(rd => rd.key === key);
          }
        }
        const fallbackKey = entries[0][0];
        return rarityDefs.find(rd => rd.key === fallbackKey);
      }

      function getRandomCardFromPack(packId) {
        const rarity = pickPackRarity(packId);
        const pool = cardsByRarity[rarity.key] || [];
        if (!pool.length) {
          return {
            id: null,
            name: 'Carta desconocida',
            image: '',
            rarityInternal: rarity.key,
            rarity,
            apiRarity: '',
            setName: '',
            types: [],
            holographic: false,
            priceEur: null,
            priceUsd: null
          };
        }
        const base = pool[Math.floor(Math.random() * pool.length)];
        return {
          ...base,
          rarity,
          rarityInternal: rarity.key
        };
      }

      const rouletteStrip = document.getElementById('rouletteStrip');
      const btnSpin = document.getElementById('btnSpin');
      const btnAuto = document.getElementById('btnAuto');
      const btnStopAuto = document.getElementById('btnStopAuto');
      const autoCountSelect = document.getElementById('autoCount');
      const resultBox = document.getElementById('rouletteResult');
      const lastDropsList = document.getElementById('lastDrops');
      const currentProbList = document.getElementById('currentProbList');
      const baseProbList = document.getElementById('baseProbList');
      const balanceBox = document.getElementById('balanceCredits');
      const spinCostEl = document.getElementById('spinCost');
      const toastContainer = document.getElementById('toastContainer');
      const wheelCards = document.querySelectorAll('.roulette-choice-card');
      const btnGoCollection = document.getElementById('btnGoCollection');
      const globalCreditsEl = document.getElementById('globalCredits');
      const shopCreditsEl = document.getElementById('shopCredits');
      const packsGrid = document.getElementById('packsGrid');
      const openPackModalEl = document.getElementById('openPackModal');
      const packInfoModalEl = document.getElementById('packInfoModal');
      const packInfoTitleEl = document.getElementById('packInfoTitle');
      const packInfoListEl = document.getElementById('packInfoList');
      const packRevealStage = document.getElementById('packRevealStage');
      const packSummaryStage = document.getElementById('packSummaryStage');
      const packRevealSlot = packRevealStage ? packRevealStage.querySelector('.pack-reveal-card-slot') : null;
      const packRevealCounter = document.getElementById('packRevealCounter');
      const btnNextReveal = document.getElementById('btnNextReveal');
      const dailyCardsGrid = document.getElementById('dailyCardsGrid');
      const dailyCardTemplate = document.getElementById('dailyCardTemplate');
      const dailyEmptyText = document.getElementById('dailyEmptyText');
      const btnRefreshDaily = document.getElementById('btnRefreshDaily');
      const refreshCostLabel = document.getElementById('refreshCostLabel');
      const rewardModalEl = document.getElementById('rewardModal');
      const rewardContinueBtn = document.getElementById('rewardContinueBtn');

      let openPackModal = openPackModalEl ? new bootstrap.Modal(openPackModalEl) : null;
      let packInfoModal = packInfoModalEl ? new bootstrap.Modal(packInfoModalEl) : null;

      let balance = 0;
      let currentWheelKey = 'common';
      let spinCost = wheelsConfig[currentWheelKey].cost;
      let isSpinning = false;
      let autoSpinsRemaining = 0;
      let autoSpinTimer = null;
      let lastDrops = [];
      let statsCounts = {
        common: 0,
        uncommon: 0,
        rare: 0,
        superrare: 0,
        elite: 0,
        epic: 0,
        mythic: 0,
        legendary: 0
      };
      let refreshDailyCost = 50;
      let autoSpinQueueActive = false; // controla si estamos en modo autogiros
      let rewardModalInstance = rewardModalEl ? new bootstrap.Modal(rewardModalEl) : null;

      function updateRefreshCostUI() {
        if (refreshCostLabel) refreshCostLabel.textContent = refreshDailyCost.toString();
      }

      function syncCreditsUI() {
        if (balanceBox) {
          const span = balanceBox.querySelector('span:last-child');
          if (span) span.textContent = balance;
        }
        if (globalCreditsEl) {
          globalCreditsEl.innerHTML = `
        <i class="bi bi-coin text-warning"></i>
        <span class="fw-bold">${balance}</span>
      `;
        }
        if (shopCreditsEl) {
          shopCreditsEl.innerHTML = `
        <i class="bi bi-coin text-warning small"></i>
        <span>${balance}</span>
      `;
        }
      }

      function updateSpinCostUI() {
        spinCost = wheelsConfig[currentWheelKey].cost;
        if (spinCostEl) {
          spinCostEl.innerHTML = `
        <i class="bi bi-coin text-warning small"></i>
        <span>${spinCost}</span>
      `;
        }
      }

      function addCardToCollection(card) {
        try {
          const key = 'pm_collection';
          const raw = localStorage.getItem(key);
          const current = raw ? JSON.parse(raw) : [];
          current.push({
            id: card.id,
            name: card.name,
            rarityInternal: card.rarityInternal,
            rarityLabel: card.rarity?.label || '',
            apiRarity: card.apiRarity || '',
            image: card.image || '',
            setName: card.setName || '',
            types: card.types || [],
            holographic: card.holographic || false,
            priceEur: card.priceEur ?? null,
            priceUsd: card.priceUsd ?? null,
            obtainedAt: new Date().toISOString()
          });
          localStorage.setItem(key, JSON.stringify(current));
        } catch (e) {
          console.error('Error guardando colección:', e);
        }
      }

      function showToast(card) {
        if (!toastContainer) return;
        const rarityKey = card.rarityInternal || 'common';
        const rarityDef = card.rarity || rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0];

        const toast = document.createElement('div');
        toast.className = 'roulette-toast';

        toast.innerHTML = `
      <div class="roulette-toast-inner rarity-${rarityKey}">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="roulette-toast-title">Drop ${rarityDef.label}</span>
          <span class="xsmall">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="roulette-toast-body">
          ${card.name || 'Carta obtenida'}
        </div>
      </div>
    `;

        toastContainer.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.add('show');
        });

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 250);
        }, 2500);
      }

      function raritySymbol(key) {
        switch (key) {
          case 'common': return '⚪';
          case 'uncommon': return '🟢';
          case 'rare': return '🔵';
          case 'superrare': return '🟣';
          case 'elite': return '💗';
          case 'epic': return '🟠';
          case 'mythic': return '✨';
          case 'legendary': return '👑';
          default: return '⬜';
        }
      }

      function updateBaseProbabilitiesUI() {
        if (!baseProbList) return;
        const cfg = wheelsConfig[currentWheelKey];
        baseProbList.innerHTML = '';
        const entries = Object.entries(cfg.probs);

        entries.forEach(([key, p]) => {
          const rd = rarityDefs.find(r => r.key === key);
          if (!rd) return;
          const pct = (p * 100).toFixed(1);
          const li = document.createElement('li');
          li.className = 'd-flex align-items-center gap-1 mb-1';
          li.innerHTML = `
        <span class="xsmall flex-shrink-0" style="width:75px; font-size:0.7rem;">${rd.label}</span>
        <div class="stats-bar-track">
          <div class="stats-bar-fill rarity-${rd.key}" style="width:${pct}%"></div>
        </div>
        <span class="xsmall text-end flex-shrink-0" style="width:42px; font-size:0.7rem;">${pct}%</span>
      `;
          baseProbList.appendChild(li);
        });
      }

      function updateCurrentProbabilities() {
        if (!currentProbList) return;
        const total = Object.values(statsCounts).reduce((a, b) => a + b, 0);
        currentProbList.innerHTML = '';

        rarityDefs.forEach(rd => {
          const count = statsCounts[rd.key] || 0;
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          const li = document.createElement('li');
          li.className = 'd-flex align-items-center gap-1 mb-1';
          li.innerHTML = `
        <span class="xsmall flex-shrink-0" style="width:75px; font-size:0.7rem;">${rd.label}</span>
        <div class="stats-bar-track">
          <div class="stats-bar-fill rarity-${rd.key}" style="width:${pct}%"></div>
        </div>
        <span class="xsmall text-end flex-shrink-0" style="width:42px; font-size:0.7rem;">${pct}%</span>
      `;
          currentProbList.appendChild(li);
        });
      }

      function fillStrip() {
        if (!rouletteStrip) return;
        rouletteStrip.innerHTML = '';
        const cfg = wheelsConfig[currentWheelKey];
        if (!cfg) return;

        const items = [];
        const rarityEntries = Object.entries(cfg.probs);
        for (let i = 0; i < 50; i++) {
          let r = Math.random();
          let acc = 0;
          let chosenKey = 'common';
          for (const [key, prob] of rarityEntries) {
            acc += prob;
            if (r <= acc) {
              chosenKey = key;
              break;
            }
          }
          const card = getRandomCardFromRarity(chosenKey);
          if (!card) continue;
          items.push(card);
        }

        items.forEach(card => {
          const rd = rarityDefs.find(r => r.key === card.rarityInternal) || rarityDefs[0];
          const div = document.createElement('div');
          div.className = `roulette-item rarity-${card.rarityInternal} d-flex align-items-center justify-content-center`;
          div.innerHTML = `
        <div class="roulette-item-inner d-flex flex-column gap-1 w-100">
          <div class="d-flex justify-content-between align-items-center">
            <span class="roulette-item-rarity">${rd.label}</span>
            <img src="${card.image || 'img/avatars/pokeball.png'}"
                 alt="${card.name}"
                 class="roulette-item-image">
          </div>
          <div class="roulette-item-name text-truncate">${card.name}</div>
        </div>
      `;
          rouletteStrip.appendChild(div);
        });
      }

      function pickResultFromStrip() {
        const items = rouletteStrip ? rouletteStrip.querySelectorAll('.roulette-item') : [];
        if (!items.length) return null;

        const centerIndex = Math.floor(items.length / 2);
        const chosen = items[centerIndex];
        if (!chosen) return null;

        const img = chosen.querySelector('img');
        const nameEl = chosen.querySelector('.roulette-item-name');
        const rarityClass = Array.from(chosen.classList).find(c => c.startsWith('rarity-')) || 'rarity-common';
        const rarityKey = rarityClass.replace('rarity-', '');
        const rd = rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0];

        const card = {
          name: nameEl ? nameEl.textContent : 'Carta',
          image: img ? img.src : 'img/avatars/pokeball.png',
          rarityInternal: rarityKey,
          rarity: rd,
          apiRarity: '',
          setName: ''
        };

        return { card, elementIndex: centerIndex, itemWidth: chosen.offsetWidth };
      }

      function animateSpin() {
        if (!rouletteStrip) return;
        isSpinning = true;
        btnSpin.disabled = true;
        btnAuto.disabled = true;

        const totalItems = rouletteStrip.children.length;
        if (!totalItems) {
          isSpinning = false;
          btnSpin.disabled = false;
          btnAuto.disabled = false;
          return;
        }

        const itemWidth = rouletteStrip.children[0].offsetWidth + 4;
        const totalWidth = totalItems * itemWidth;

        const visibleWidth = rouletteStrip.parentElement.offsetWidth;
        const centerOffset = (visibleWidth / 2) - (itemWidth / 2);

        const targetIndex = Math.floor(totalItems / 2);
        const targetX = - (targetIndex * itemWidth) + centerOffset;

        const startX = targetX + totalWidth * 1.5;

        let start = null;
        const duration = 2600;

        function step(timestamp) {
          if (!start) start = timestamp;
          const elapsed = timestamp - start;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          const current = startX + (targetX - startX) * eased;
          rouletteStrip.style.transform = `translateX(${current}px)`;

          if (progress < 1) {
            window.requestAnimationFrame(step);
          } else {
            rouletteStrip.style.setProperty('--roulette-offset', `${current}px`);
            rouletteStrip.classList.add('roulette-strip-bounce');
            setTimeout(() => {
              rouletteStrip.classList.remove('roulette-strip-bounce');
              onSpinEnd();
            }, 220);
          }
        }

        window.requestAnimationFrame(step);
      }

      function onSpinEnd() {
        isSpinning = false;
        const result = pickResultFromStrip();
        if (!result) {
          if (resultBox) {
            resultBox.innerHTML = `
          <span class="small text-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>No se pudo determinar la carta.
          </span>
        `;
          }
        } else {
          const card = result.card;
          const rd = card.rarity;

          statsCounts[card.rarityInternal] = (statsCounts[card.rarityInternal] || 0) + 1;
          updateCurrentProbabilities();

          lastDrops.unshift(card);
          if (lastDrops.length > 6) lastDrops.pop();
          if (lastDropsList) {
            lastDropsList.innerHTML = '';
            lastDrops.forEach(c => {
              const li = document.createElement('li');
              li.className = 'd-flex align-items-center justify-content-between mb-1';
              li.innerHTML = `
            <div class="d-flex align-items-center gap-1 text-truncate me-2">
              <span>${raritySymbol(c.rarityInternal)}</span>
              <span class="text-truncate">${c.name}</span>
            </div>
            <span class="badge xsmall rarity-${c.rarityInternal}">${c.rarity.label}</span>
          `;
              lastDropsList.appendChild(li);
            });
          }

          addCardToCollection(card);

          if (resultBox) {
            resultBox.innerHTML = `
          <div class="d-flex flex-column align-items-center">
            <span class="small mb-1">Última carta:</span>
            <span class="fw-semibold">${card.name}</span>
            <span class="badge mt-1 xsmall rarity-${card.rarityInternal}">${rd.label}</span>
          </div>
        `;
          }

          showToast(card);

          if (rewardModalEl && rewardModalInstance) {
            const rewardTitle = document.getElementById('rewardTitle');
            const rewardImg = document.getElementById('rewardImage');
            const rewardBadge = document.getElementById('rewardRarityBadge');
            const rewardSet = document.getElementById('rewardSetName');

            if (rewardTitle) rewardTitle.textContent = `¡${rd.label}! ${card.name}`;
            if (rewardImg) rewardImg.src = card.image || 'img/avatars/pokeball.png';
            if (rewardBadge) {
              rewardBadge.textContent = rd.label;
              rewardBadge.className = 'badge rarity-' + card.rarityInternal;
            }
            if (rewardSet) rewardSet.textContent = card.setName || '';

            rewardModalInstance.show();
          }
        }

        // NO continuamos aquí los autogiros, solo marcamos que hay pendientes
        if (autoSpinsRemaining > 0) {
          autoSpinQueueActive = true;
        } else {
          autoSpinQueueActive = false;
          btnAuto.classList.remove('d-none');
          btnStopAuto.classList.add('d-none');
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        }
      }

      function startSpin() {
        if (isSpinning) return;
        if (balance < spinCost) {
          showToast({
            name: 'No tienes monedas suficientes',
            rarity: { id: 1, label: 'Común', key: 'common' },
            rarityInternal: 'common'
          });
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          if (btnStopAuto) btnStopAuto.classList.add('d-none');
          if (btnAuto) btnAuto.classList.remove('d-none');
          return;
        }
        balance -= spinCost;
        syncCreditsUI();
        persistCredits();
        fillStrip();
        animateSpin();
      }

      if (btnSpin) {
        btnSpin.addEventListener('click', () => {
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          startSpin();
        });
      }

      if (btnAuto && btnStopAuto) {
        btnAuto.addEventListener('click', () => {
          if (isSpinning) return;
          const count = parseInt(autoCountSelect.value, 10) || 10;
          autoSpinsRemaining = count;
          autoSpinQueueActive = true;
          btnAuto.classList.add('d-none');
          btnStopAuto.classList.remove('d-none');
          startSpin();
        });

        btnStopAuto.addEventListener('click', () => {
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          if (autoSpinTimer) {
            clearTimeout(autoSpinTimer);
            autoSpinTimer = null;
          }
          btnAuto.classList.remove('d-none');
          btnStopAuto.classList.add('d-none');
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        });
      }

      // Cuando cierras el modal de recompensa o pulsas "Seguir girando",
      // si quedan autogiros pendientes, lanza el siguiente.
      if (rewardContinueBtn && rewardModalEl && rewardModalInstance) {
        rewardContinueBtn.addEventListener('click', () => {
          rewardModalInstance.hide();
          if (autoSpinsRemaining > 0 && autoSpinQueueActive) {
            autoSpinsRemaining--;
            if (balance >= spinCost) {
              setTimeout(() => startSpin(), 250);
            } else {
              autoSpinsRemaining = 0;
              autoSpinQueueActive = false;
              btnAuto.classList.remove('d-none');
              btnStopAuto.classList.add('d-none');
            }
          } else {
            autoSpinQueueActive = false;
            btnAuto.classList.remove('d-none');
            btnStopAuto.classList.add('d-none');
            btnSpin.disabled = balance < spinCost;
            btnAuto.disabled = balance < spinCost;
          }
        });
      }

      if (wheelCards.length) {
        wheelCards.forEach(cardEl => {
          cardEl.addEventListener('click', () => {
            if (cardEl.classList.contains('active') || isSpinning) return;
            wheelCards.forEach(c => c.classList.remove('active'));
            cardEl.classList.add('active');

            currentWheelKey = cardEl.getAttribute('data-wheel') || 'common';
            updateSpinCostUI();
            updateBaseProbabilitiesUI();
            fillStrip();
          });
        });
      }

      if (btnGoCollection) {
        btnGoCollection.addEventListener('click', () => {
          window.location.href = 'Pages/Colección.html';
        });
      }

      const storedCredits = localStorage.getItem('pm_credits');
      if (storedCredits) {
        const parsed = parseInt(storedCredits, 10);
        if (!isNaN(parsed)) {
          balance = parsed;
        }
      }

      function persistCredits() {
        localStorage.setItem('pm_credits', String(balance));
      }

      const creditButtons = document.querySelectorAll('.credit-buy-btn');
      creditButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const amount = parseInt(btn.getAttribute('data-amount'), 10) || 0;
          balance += amount;
          syncCreditsUI();
          persistCredits();
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        });
      });

      function showPackInfo(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg || !packInfoModal) return;

        if (packInfoTitleEl) {
          packInfoTitleEl.textContent = `Probabilidades – ${cfg.name}`;
        }
        if (packInfoListEl) {
          packInfoListEl.innerHTML = '';
          const entries = Object.entries(cfg.probs);
          entries.forEach(([key, p]) => {
            const rd = rarityDefs.find(r => r.key === key);
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center mb-1';
            li.innerHTML = `
          <span>${rd ? rd.label : key}</span>
          <span class="fw-semibold">${(p * 100).toFixed(1)}%</span>
        `;
            packInfoListEl.appendChild(li);
          });
        }
        packInfoModal.show();
      }

      if (packsGrid) {
        const infoBtns = packsGrid.querySelectorAll('.pack-info-btn');
        infoBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const packId = btn.getAttribute('data-pack-id');
            showPackInfo(packId);
          });
        });
      }

      function showPackAnimation(cards, cfg) {
        if (!openPackModalEl || !packRevealStage || !packSummaryStage || !packRevealSlot) return;
        if (!openPackModal) openPackModal = new bootstrap.Modal(openPackModalEl);

        let index = 0;
        const total = cards.length;

        packSummaryStage.classList.add('d-none');
        packRevealStage.classList.remove('d-none');

        function renderCard(i) {
          const c = cards[i];
          const rd = c.rarity;
          packRevealSlot.innerHTML = `
        <div class="pack-reveal-card-inner rarity-${rd.key}">
          <img src="${c.image || 'img/avatars/pokeball.png'}"
               alt="${c.name}"
               style="width:100%;height:100%;object-fit:cover;">
        </div>
      `;
          if (packRevealCounter) {
            packRevealCounter.textContent = `Carta ${i + 1} de ${total}`;
          }
        }

        renderCard(index);

        if (btnNextReveal) {
          btnNextReveal.onclick = () => {
            index++;
            if (index >= total) {
              packRevealStage.classList.add('d-none');
              packSummaryStage.classList.remove('d-none');
              const grid = document.getElementById('packCardsGrid');
              if (grid) {
                grid.innerHTML = '';
                cards.forEach(c => {
                  const rd = c.rarity;
                  const col = document.createElement('div');
                  col.className = 'col-6 col-md-4 col-lg-3 mb-2';
                  col.innerHTML = `
                <article class="card card-carta h-100">
                  <div class="card-carta-frame">
                    <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
                      <img src="${c.image || 'img/avatars/pokeball.png'}"
                           class="carta-img-real"
                           alt="${c.name}">
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <h5 class="small fw-semibold mb-0 text-truncate">${c.name}</h5>
                      <span class="badge xsmall rarity-${rd.key}">${rd.label}</span>
                    </div>
                    <p class="xsmall text-muted mb-0 text-truncate">${c.setName || ''}</p>
                  </div>
                </article>
              `;
                  grid.appendChild(col);
                });
              }
              return;
            }
            renderCard(index);
          };
        }

        const titleEl = openPackModalEl.querySelector('#openPackTitle');
        if (titleEl) titleEl.textContent = `${cfg.name} – Apertura dopamina`;
        openPackModal.show();
      }

      function openPack(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg) return;

        if (balance < cfg.price) {
          showToast({
            name: 'No tienes monedas suficientes para este sobre',
            rarity: { id: 1, label: 'Común', key: 'common' },
            rarityInternal: 'common'
          });
          return;
        }

        balance -= cfg.price;
        syncCreditsUI();
        persistCredits();

        const cards = [];
        const numCards = 6;
        for (let i = 0; i < numCards; i++) {
          const c = getRandomCardFromPack(packId);
          cards.push(c);
          addCardToCollection(c);
        }

        showPackAnimation(cards, cfg);
      }

      if (packsGrid) {
        const openButtons = packsGrid.querySelectorAll('.pack-open-btn');
        openButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const packId = btn.getAttribute('data-pack-id');
            openPack(packId);
          });
        });
      }

      function generateDailyCards(forceRandom = false) {
        if (!dailyCardsGrid || !dailyCardTemplate) return;

        dailyCardsGrid.innerHTML = '';
        const seedBase = getDailySeed();

        const poolKeys = ['uncommon', 'rare', 'superrare', 'elite'];
        const pool = poolKeys.flatMap(k => cardsByRarity[k] || []);

        if (!pool.length) {
          if (dailyEmptyText) {
            dailyEmptyText.textContent = 'No hay cartas disponibles todavía. Prueba a recargar en unos segundos.';
            dailyCardsGrid.appendChild(dailyEmptyText);
          }
          return;
        }

        const numDaily = 8;
        const usedIndexes = new Set();

        for (let i = 0; i < numDaily; i++) {
          let idx;
          if (forceRandom) {
            let tries = 0;
            do {
              idx = Math.floor(Math.random() * pool.length);
              tries++;
            } while (usedIndexes.has(idx) && tries < 20);
          } else {
            const seed = `${seedBase}-${i}`;
            idx = seededRandom(seed, pool.length);
          }

          usedIndexes.add(idx);
          const card = pool[idx];

          const clone = dailyCardTemplate.cloneNode(true);
          clone.id = '';
          clone.classList.remove('d-none');

          const nameEl = clone.querySelector('.daily-name');
          const rarityEl = clone.querySelector('.daily-rarity');
          const setEl = clone.querySelector('.daily-set');
          const priceEl = clone.querySelector('.daily-price');
          const stockEl = clone.querySelector('.daily-stock');
          const buyBtn = clone.querySelector('.daily-buy-btn');
          const imgWrap = clone.querySelector('.carta-img-placeholder');

          if (nameEl) nameEl.textContent = card.name || 'Carta sin nombre';
          if (setEl) setEl.textContent = card.setName || 'Set desconocido';

          const internal = mapApiRarityToInternal(card);
          const rd = rarityDefs.find(r => r.key === internal) || rarityDefs[2];

          const basePrice = rarityPriceMap[internal] || 50;
          if (priceEl) priceEl.textContent = basePrice.toString();

          if (rarityEl) {
            rarityEl.textContent = rd.label;
            rarityEl.className = 'badge xsmall rarity-' + rd.key;
          }

          if (stockEl) stockEl.textContent = 'Stock: ∞';

          if (imgWrap) {
            if (card.image) {
              imgWrap.innerHTML = `
            <img src="${card.image}" class="carta-img-real" alt="${card.name}">
          `;
            } else {
              imgWrap.innerHTML = `
            <img src="img/avatars/pokeball.png" class="carta-img-real" alt="${card.name}">
          `;
            }
          }

          if (buyBtn) {
            buyBtn.addEventListener('click', () => {
              const price = parseInt(priceEl.textContent, 10) || 0;
              if (balance < price) {
                showToast({
                  name: 'No tienes monedas suficientes',
                  rarity: { id: 1, label: 'Común', key: 'common' },
                  rarityInternal: 'common'
                });
                return;
              }
              balance -= price;
              syncCreditsUI();
              persistCredits();

              addCardToCollection({
                id: card.id,
                name: card.name,
                rarityInternal: internal,
                rarity: rd,
                image: card.image,
                apiRarity: card.apiRarity,
                setName: card.setName,
                types: card.types || [],
                holographic: card.holographic || false,
                priceEur: card.priceEur ?? null,
                priceUsd: card.priceUsd ?? null
              });
              showToast({
                name: `Comprada: ${card.name}`,
                rarity: rd,
                rarityInternal: internal
              });
            });
          }

          dailyCardsGrid.appendChild(clone);
        }

        if (dailyEmptyText) {
          dailyEmptyText.textContent = '';
        }
      }

      if (btnRefreshDaily) {
        btnRefreshDaily.addEventListener('click', () => {
          if (balance < refreshDailyCost) {
            showToast({
              name: 'No tienes monedas para recargar la tienda',
              rarity: { id: 1, label: 'Común', key: 'common' },
              rarityInternal: 'common'
            });
            return;
          }
          balance -= refreshDailyCost;
          syncCreditsUI();
          persistCredits();
          refreshDailyCost += 50;
          updateRefreshCostUI();
          generateDailyCards(true);
        });
      }

      // Carga rápida inicial
      await loadAllCardsFromApi(5);
      fillStrip();
      if (btnSpin) btnSpin.disabled = false;
      if (btnAuto) btnAuto.disabled = false;
      if (resultBox) {
        resultBox.innerHTML = `
      <span class="small text-info">
        <i class="bi bi-dice-5 me-1"></i>Cartas listas. Elige ruleta o tira 1 vez.
      </span>
    `;
      }

      // Carga extendida en background
      loadAllCardsFromApi(40).then(() => {
        fillStrip();
        generateDailyCards();
      });

      updateSpinCostUI();
      updateBaseProbabilitiesUI();
      updateCurrentProbabilities();
      updateRefreshCostUI();
      syncCreditsUI();

      window.addEventListener('beforeunload', () => {
        persistCredits();
      });
    });
  </script>

</body>

</html>