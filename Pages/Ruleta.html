<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>PokeMarket - Ruleta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../CSS/style.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-main shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="../Index.html">
      <img src="../img/Masterball.png" alt="Masterball" style="width: 32px; height: 32px;">
      <span class="brand-text">PokeMarket</span>
    </a>

    <button class="navbar-toggler collapsed" type="button"
            data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"><span></span></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-3 nav-links">
        <li class="nav-item"><a class="nav-link" href="../Index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Mercado</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Colección</a></li>
        <li class="nav-item"><a class="nav-link" href="Perfil.html">Perfil</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Ruleta</a></li>
      </ul>

      <div class="ms-auto d-flex align-items-center gap-3 flex-wrap justify-content-end">
        <div class="d-flex align-items-center gap-2 order-1 order-lg-0">
          <i class="bi bi-sun small text-warning"></i>
          <div class="form-check form-switch mb-0">
            <input class="form-check-input theme-switch" type="checkbox" id="darkModeSwitch">
          </div>
          <i class="bi bi-moon-stars small text-secondary-emphasis"></i>
        </div>

        <div class="dropdown order-0 order-lg-1">
          <button class="btn btn-profile" type="button" id="profileDropdown" data-bs-toggle="dropdown">
            <img src="../img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar me-2" id="navbarAvatar">
            <span class="d-none d-sm-inline user-name" id="navbarUserName">Entrenador</span>
            <i class="bi bi-caret-down-fill ms-1 small d-none d-sm-inline"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown">
            <li class="px-3 py-2">
              <div class="d-flex align-items-center">
                <img src="../img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar me-2" id="dropdownAvatar">
                <div class="min-w-0">
                  <div class="fw-semibold small text-truncate" id="dropdownUserName">Entrenador</div>
                  <div class="text-muted xsmall text-truncate" id="dropdownUserEmail">entrenador@pokemarket.com</div>
                </div>
              </div>
            </li>
            <li><hr class="dropdown-divider my-1"></li>
            <li><a class="dropdown-item small" href="Perfil.html"><i class="bi bi-person-badge me-2"></i>Ver perfil</a></li>
            <li><a class="dropdown-item small" href="InicioSesion.html" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">

    <section class="roulette-header text-center mb-3">
      <h1 class="h3 fw-bold mb-2">Ruleta legendaria</h1>
      <p class="small text-muted mb-0">
        Convierte tus créditos en <span class="text-warning fw-semibold">drops insanos</span>.
      </p>
    </section>

    <!-- Botón comprar créditos -->
    <div class="d-flex justify-content-center mb-3">
      <a href="Tienda.html" class="btn btn-buy-credits">
        <span class="btn-buy-credits-glow"></span>
        <i class="bi bi-plus-circle-fill me-2"></i>Comprar créditos
      </a>
    </div>

    <div class="row g-4 align-items-start">

      <!-- RULETA -->
      <div class="col-lg-8">
        <section class="roulette-card card border-0 shadow-lg rounded-4">
          <div class="card-header border-0 roulette-card-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge bg-danger-subtle text-danger-emphasis xsmall me-2">
                  <i class="bi bi-lightning-charge-fill me-1"></i>Ruleta activa
                </span>
                <span class="badge bg-warning-subtle text-warning-emphasis xsmall">
                  Boost x1.5 en épicas y superiores
                </span>
              </div>
              <div class="text-end">
                <span class="xsmall text-muted d-block">Balance</span>
                <span class="small fw-semibold text-success" id="balanceCredits">1250</span>
                <span class="xsmall text-muted">créditos</span>
              </div>
            </div>
          </div>

          <div class="card-body roulette-body">
            <!-- Rarezas -->
            <div class="roulette-rarities d-flex flex-wrap justify-content-between align-items-center mb-3">
              <div class="rarity-pill rarity-1"><span class="rarity-color-dot"></span>Común</div>
              <div class="rarity-pill rarity-2"><span class="rarity-color-dot"></span>Infrecuente</div>
              <div class="rarity-pill rarity-3"><span class="rarity-color-dot"></span>Rara</div>
              <div class="rarity-pill rarity-4"><span class="rarity-color-dot"></span>Super rara</div>
              <div class="rarity-pill rarity-5"><span class="rarity-color-dot"></span>Élite</div>
              <div class="rarity-pill rarity-6"><span class="rarity-color-dot"></span>Épica</div>
              <div class="rarity-pill rarity-7"><span class="rarity-color-dot"></span>Mítica</div>
              <div class="rarity-pill rarity-8"><span class="rarity-color-dot"></span>Legendaria</div>
            </div>

            <!-- Ventana -->
            <div class="roulette-window-wrapper mb-3">
              <div class="roulette-highlight"></div>
              <div class="roulette-window">
                <div class="roulette-strip" id="rouletteStrip"></div>
              </div>
              <div class="roulette-bottom-glow"></div>
            </div>

            <!-- Resultado -->
            <div class="roulette-result text-center mb-3" id="rouletteResult">
              <span class="small text-info">
                <i class="bi bi-dice-5 me-1"></i>Elige giros o tira 1 vez para empezar.
              </span>
            </div>

            <!-- Controles -->
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="d-flex align-items-center gap-1">
                  <span class="xsmall text-muted">Auto giros:</span>
                  <select class="form-select form-select-sm roulette-autospins-select" id="autoCount">
                    <option value="5">5 giros</option>
                    <option value="10" selected>10 giros</option>
                    <option value="15">15 giros</option>
                    <option value="20">20 giros</option>
                    <option value="25">25 giros</option>
                    <option value="30">30 giros (MAX)</option>
                  </select>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="btnAuto">
                    <i class="bi bi-arrow-repeat me-1"></i>Auto giros
                  </button>
                  <button class="btn btn-outline-danger btn-sm d-none" type="button" id="btnStopAuto">
                    <i class="bi bi-stop-circle me-1"></i>Parar
                  </button>
                </div>
              </div>

              <div class="text-end">
                <div class="xsmall text-muted mb-1">
                  Coste por giro:
                  <span class="text-warning fw-semibold" id="spinCost">50</span> créditos
                </div>
                <button class="btn btn-poke btn-lg fw-semibold" id="btnSpin">
                  <i class="bi bi-dice-5 me-1"></i>Girar 1 vez
                </button>
              </div>
            </div>

          </div>

          <div class="card-footer border-0 roulette-footer xsmall text-muted">
            Los objetos ganados se añaden automáticamente a tu inventario. Las cartas duplicadas podrán convertirse en créditos.
          </div>
        </section>
      </div>

      <!-- PANEL DERECHA -->
      <div class="col-lg-4">
        <section class="card border-0 shadow-sm rounded-4 mb-3">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-graph-up-arrow me-1"></i>Probabilidades base</h2>
            <ul class="list-unstyled mb-0 xsmall">
              <li class="d-flex justify-content-between"><span>Común</span><span class="text-muted">40 %</span></li>
              <li class="d-flex justify-content-between"><span>Infrecuente</span><span class="text-muted">22 %</span></li>
              <li class="d-flex justify-content-between"><span>Rara</span><span class="text-muted">15 %</span></li>
              <li class="d-flex justify-content-between"><span>Super rara</span><span class="text-muted">8 %</span></li>
              <li class="d-flex justify-content-between"><span>Élite</span><span class="text-muted">6 %</span></li>
              <li class="d-flex justify-content-between text-info"><span>Épica</span><span>5 %</span></li>
              <li class="d-flex justify-content-between text-warning"><span>Mítica</span><span>3 %</span></li>
              <li class="d-flex justify-content-between text-warning fw-semibold"><span>Legendaria</span><span>1 %</span></li>
            </ul>
          </div>
        </section>

        <section class="card border-0 shadow-sm rounded-4 mb-3">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-activity me-1"></i>Porcentajes actuales</h2>
            <p class="xsmall text-muted">Basado en los últimos giros.</p>
            <ul class="list-unstyled mb-0 xsmall" id="currentProbList"></ul>
          </div>
        </section>

        <section class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-trophy-fill text-warning me-1"></i>Últimas cartas ganadas</h2>
            <ul class="list-unstyled mb-0 xsmall" id="lastDrops"></ul>
          </div>
        </section>
      </div>

    </div>

    <!-- Aviso casi invisible -->
    <p class="roulette-disclaimer text-center mt-4">
      Probabilidades fijas por rareza. Juega con responsabilidad.
    </p>

  </div>
</main>

<!-- Toast notificaciones -->
<div class="roulette-toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const html = document.documentElement;
  const switchElement = document.getElementById('darkModeSwitch');

  const savedTheme = localStorage.getItem('bsTheme') || 'light';
  html.setAttribute('data-bs-theme', savedTheme);
  if (switchElement) {
    switchElement.checked = savedTheme === 'dark';
    switchElement.addEventListener('change', function () {
      const theme = this.checked ? 'dark' : 'light';
      html.setAttribute('data-bs-theme', theme);
      localStorage.setItem('bsTheme', theme);
    });
  }

  const defaultName   = 'Entrenador';
  const defaultEmail  = 'entrenador@gmail.com';
  const defaultAvatar = '../img/avatars/pokeball.png';

  const name   = localStorage.getItem('pm_user_name')   || defaultName;
  const email  = localStorage.getItem('pm_user_email')  || defaultEmail;
  const avatar = localStorage.getItem('pm_user_avatar') || defaultAvatar;

  const navbarUserName    = document.getElementById('navbarUserName');
  const dropdownUserName  = document.getElementById('dropdownUserName');
  const dropdownUserEmail = document.getElementById('dropdownUserEmail');
  const navbarAvatar      = document.getElementById('navbarAvatar');
  const dropdownAvatar    = document.getElementById('dropdownAvatar');

  if (navbarUserName)    navbarUserName.textContent = name;
  if (dropdownUserName)  dropdownUserName.textContent = name;
  if (dropdownUserEmail) dropdownUserEmail.textContent = email;
  if (navbarAvatar)      navbarAvatar.src = avatar;
  if (dropdownAvatar)    dropdownAvatar.src = avatar;

  const logoutLink = document.getElementById('logoutLink');
  if (logoutLink) {
    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('pm_user_name');
      localStorage.removeItem('pm_user_email');
      localStorage.removeItem('pm_user_avatar');
      localStorage.removeItem('pm_user_bio');
      localStorage.removeItem('pm_cards_sale');
      window.location.href = 'InicioSesion.html';
    });
  }

  // RUETA
  const rouletteStrip = document.getElementById('rouletteStrip');
  const btnSpin = document.getElementById('btnSpin');
  const btnAuto = document.getElementById('btnAuto');
  const btnStopAuto = document.getElementById('btnStopAuto');
  const autoCountSelect = document.getElementById('autoCount');
  const resultBox = document.getElementById('rouletteResult');
  const lastDropsList = document.getElementById('lastDrops');
  const currentProbList = document.getElementById('currentProbList');
  const balanceEl = document.getElementById('balanceCredits');
  const spinCostEl = document.getElementById('spinCost');
  const toastContainer = document.getElementById('toastContainer');

  if (!rouletteStrip || !btnSpin) return;

  // Créditos
  let balance = 1250;
  const spinCost = 50;
  if (balanceEl) balanceEl.textContent = balance.toString();
  if (spinCostEl) spinCostEl.textContent = spinCost.toString();

  // Rarezas
  const rarityDefs = [
    { id: 1, key: 'common',      label: 'Común',          baseProb: 0.40 },
    { id: 2, key: 'uncommon',    label: 'Infrecuente',    baseProb: 0.22 },
    { id: 3, key: 'rare',        label: 'Rara',           baseProb: 0.15 },
    { id: 4, key: 'superrare',   label: 'Super rara',     baseProb: 0.08 },
    { id: 5, key: 'elite',       label: 'Élite',          baseProb: 0.06 },
    { id: 6, key: 'epic',        label: 'Épica',          baseProb: 0.05 },
    { id: 7, key: 'mythic',      label: 'Mítica',         baseProb: 0.03 },
    { id: 8, key: 'legendary',   label: 'Legendaria',     baseProb: 0.01 }
  ]; // [web:115][web:127]

  // Gran pool ejemplo
  const cardsPool = [
    'Rattata','Pidgey','Magikarp','Caterpie','Weedle','Spearow','Zubat','Geodude','Poliwag','Slowpoke',
    'Grimer','Koffing','Rhyhorn','Goldeen','Krabby','Doduo','Tentacool','Sandshrew','Nidoran','Paras',
    'Eevee','Ivysaur','Charmeleon','Wartortle','Ponyta','Growlithe','Haunter','Kadabra','Machoke','Gloom',
    'Weepinbell','Dragonair','Fearow','Seadra','Onix',
    'Pikachu holo','Gengar','Lapras','Ninetales','Jolteon','Vaporeon','Flareon','Alakazam','Snorlax',
    'Gyarados','Aerodactyl','Hitmonlee','Hitmonchan',
    'Blastoise','Venusaur','Charizard holo','Dragonite','Tyranitar','Scizor','Houndoom','Umbreon','Espeon',
    'Charizard EX','Blastoise EX','Venusaur EX','Gyarados EX','Moltres EX','Zapdos EX','Articuno EX',
    'Lugia GX','Ho-Oh GX','Rayquaza GX','Mewtwo GX','Suicune GX','Raikou GX','Entei GX','Latios GX','Latias GX',
    'Mewtwo VMAX','Rayquaza VMAX','Charizard VMAX','Gengar VMAX','Umbreon VMAX','Sylveon VMAX',
    'Rayquaza Gold','Mew Gold','Arceus Gold','Charizard Rainbow','Pikachu Illustrator'
  ];

  function getCardsByRarity(rarityId) {
    if (rarityId === 1) return cardsPool.slice(0, 20);
    if (rarityId === 2) return cardsPool.slice(20, 37);
    if (rarityId === 3) return cardsPool.slice(37, 51);
    if (rarityId === 4) return cardsPool.slice(51, 60);
    if (rarityId === 5) return cardsPool.slice(60, 67);
    if (rarityId === 6) return cardsPool.slice(67, 76);
    if (rarityId === 7) return cardsPool.slice(76, 82);
    if (rarityId === 8) return cardsPool.slice(82);
    return cardsPool;
  }

  function pickRarity() {
    const r = Math.random();
    let acc = 0;
    for (const rd of rarityDefs) {
      acc += rd.baseProb;
      if (r <= acc) return rd;
    }
    return rarityDefs[0];
  }

  function pickCard() {
    const rarity = pickRarity();
    const pool = getCardsByRarity(rarity.id);
    const name = pool[Math.floor(Math.random() * pool.length)];
    return { name, rarity };
  }

  function createItem(card) {
    const item = document.createElement('div');
    item.className = 'roulette-item rarity-' + card.rarity.key;
    item.innerHTML = `
      <div class="roulette-item-inner">
        <div class="roulette-item-rarity">${card.rarity.label}</div>
        <div class="roulette-item-name text-truncate">${card.name}</div>
      </div>
    `;
    return item;
  }

  function fillStrip() {
    rouletteStrip.innerHTML = '';
    const totalItems = 80;
    for (let i = 0; i < totalItems; i++) {
      const card = pickCard();
      rouletteStrip.appendChild(createItem(card));
    }
    rouletteStrip.style.transform = 'translateX(0px)';
  }

  fillStrip();

  // Estadísticas sesión
  const stats = {};
  rarityDefs.forEach(rd => { stats[rd.key] = 0; });
  let totalSpins = 0;

  function updateCurrentProbabilities() {
    if (!currentProbList) return;
    currentProbList.innerHTML = '';
    if (totalSpins === 0) {
      const li = document.createElement('li');
      li.textContent = 'Aún no hay datos. Gira la ruleta para empezar.';
      currentProbList.appendChild(li);
      return;
    }
    rarityDefs.forEach(rd => {
      const count = stats[rd.key];
      const perc = (count / totalSpins) * 100;
      const li = document.createElement('li');
      li.className = 'd-flex justify-content-between mb-1';
      li.innerHTML = `
        <span>${rd.label}</span>
        <span class="${rd.id >= 6 ? 'text-warning fw-semibold' : ''}">${perc.toFixed(1)} %</span>
      `;
      currentProbList.appendChild(li);
    });
  }

  function pushLastDrop(card) {
    if (!lastDropsList) return;
    const li = document.createElement('li');
    li.className = 'd-flex justify-content-between mb-1';
    const rarityClass =
      card.rarity.id >= 8 ? 'bg-warning-subtle text-warning-emphasis' :
      card.rarity.id >= 6 ? 'bg-info-subtle text-info-emphasis' :
      'bg-primary-subtle text-primary-emphasis';
    li.innerHTML = `
      <span class="text-truncate me-2">${card.name}</span>
      <span class="badge ${rarityClass}">${card.rarity.label}</span>
    `;
    lastDropsList.prepend(li);
    while (lastDropsList.children.length > 8) {
      lastDropsList.removeChild(lastDropsList.lastElementChild);
    }
  }

  // Toast
  function showToast(card) {
    if (!toastContainer) return;
    const toast = document.createElement('div');
    toast.className = 'roulette-toast';
    toast.innerHTML = `
      <div class="roulette-toast-inner rarity-${card.rarity.key}">
        <div class="roulette-toast-title">
          <i class="bi bi-stars me-1"></i>¡Nueva carta!
        </div>
        <div class="roulette-toast-body">
          <span class="fw-semibold">${card.name}</span>
          <span class="xsmall ms-1 text-muted">(${card.rarity.label})</span>
        </div>
      </div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  let spinning = false;
  let autoMode = false;
  let autoSpinsLeft = 0;

  function doSpin(callback) {
    if (spinning) {
      if (callback) callback();
      return;
    }
    if (balance < spinCost) {
      if (resultBox) {
        resultBox.innerHTML = '<span class="small text-danger">No tienes créditos suficientes.</span>';
      }
      if (callback) callback();
      return;
    }

    balance -= spinCost;
    if (balanceEl) balanceEl.textContent = balance.toString();

    spinning = true;
    fillStrip();

    const items = Array.from(rouletteStrip.children);
    if (!items.length) {
      spinning = false;
      if (callback) callback();
      return;
    }

    const visibleIndex = Math.floor(items.length / 2);
    const winnerIndex = visibleIndex + Math.floor(Math.random() * 10); // siempre hacia delante
    const finalIndex = Math.max(3, Math.min(items.length - 4, winnerIndex));

    const itemRect = items[0].getBoundingClientRect();
    const itemWidth = itemRect.width + 4;
    const windowWidth = rouletteStrip.parentElement.getBoundingClientRect().width;
    const targetCenter = finalIndex * itemWidth + itemWidth / 2;
    const offset = targetCenter - windowWidth / 2;

    const duration = 2600;
    const startX = 0;
    const endX = Math.max(offset, 0);
    const startTime = performance.now();

    function animate(now) {
      const t = Math.min(1, (now - startTime) / duration);
      const ease = t < 1 ? (1 - Math.pow(1 - t, 3)) : 1; // easeOutCubic[web:136][web:140]
      const current = startX + (endX - startX) * ease;
      rouletteStrip.style.transform = `translateX(-${current}px)`;
      rouletteStrip.style.setProperty('--roulette-offset', `-${current}px`);

      if (t < 1 && spinning) {
        requestAnimationFrame(animate);
      } else {
        finishSpin(finalIndex, items, callback);
      }
    }

    if (resultBox) {
      resultBox.innerHTML = '<span class="small text-info"><i class="bi bi-dice-5 me-1"></i>Girando...</span>';
    }

    requestAnimationFrame(animate);
  }

  function finishSpin(finalIndex, items, callback) {
    const winnerItem = items[finalIndex];
    const rarityText = winnerItem.querySelector('.roulette-item-rarity')?.textContent || 'Común';
    const nameText = winnerItem.querySelector('.roulette-item-name')?.textContent || 'Carta misteriosa';
    const rarity = rarityDefs.find(r => r.label === rarityText) || rarityDefs[0];
    const card = { name: nameText, rarity };

    stats[card.rarity.key] += 1;
    totalSpins += 1;
    updateCurrentProbabilities();
    pushLastDrop(card);
    showToast(card);

    let extra = '';
    if (card.rarity.id >= 8) {
      extra = ' <span class="text-warning fw-bold">DROP LEGENDARIO INSANO</span>';
    } else if (card.rarity.id >= 7) {
      extra = ' <span class="text-warning fw-semibold">¡Mítica!</span>';
    } else if (card.rarity.id >= 6) {
      extra = ' <span class="text-info fw-semibold">Épica sólida.</span>';
    }

    if (resultBox) {
      resultBox.innerHTML = `
        <span class="small">
          Resultado: <span class="fw-semibold text-${card.rarity.id >= 7 ? 'warning' : (card.rarity.id >= 5 ? 'info' : 'success')}">
            ${card.name}
          </span> <span class="xsmall text-muted">(${card.rarity.label})</span>${extra}
        </span>
      `;
    }

    spinning = false;
    if (callback) callback();
  }

  btnSpin.addEventListener('click', () => {
    if (autoMode) return;
    doSpin();
  });

  function updateAutoButtons() {
    if (autoMode) {
      btnAuto.classList.add('disabled');
      btnStopAuto.classList.remove('d-none');
      btnStopAuto.disabled = false;
      btnSpin.disabled = true;
    } else {
      btnAuto.classList.remove('disabled');
      btnStopAuto.classList.add('d-none');
      btnSpin.disabled = false;
    }
  }

  function runNextAuto() {
    if (!autoMode || autoSpinsLeft <= 0) {
      autoMode = false;
      updateAutoButtons();
      return;
    }
    autoSpinsLeft--;
    doSpin(() => {
      if (!autoMode) return;
      setTimeout(runNextAuto, 280);
    });
  }

  btnAuto.addEventListener('click', () => {
    if (autoMode || spinning) return;
    const count = parseInt(autoCountSelect.value, 10) || 10;
    autoSpinsLeft = count;
    autoMode = true;
    updateAutoButtons();
    runNextAuto();
  });

  btnStopAuto.addEventListener('click', () => {
    autoMode = false;
    autoSpinsLeft = 0;
    updateAutoButtons();
  });

  updateCurrentProbabilities();
});
</script>

</body>
</html>
