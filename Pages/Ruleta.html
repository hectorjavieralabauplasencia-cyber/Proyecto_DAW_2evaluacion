<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>PokeMarket - Ruletas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../CSS/style.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-main shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="../Index.html">
      <span class="sanaball-logo"></span>
      <span class="brand-text">PokeMarket</span>
    </a>

    <button class="navbar-toggler collapsed" type="button"
            data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"><span></span></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-3 nav-links">
        <li class="nav-item"><a class="nav-link" href="../Index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="Tienda.html">Mercado</a></li>
        <li class="nav-item"><a class="nav-link" href="Colección.html">Colección</a></li>
        <li class="nav-item"><a class="nav-link" href="Perfil.html">Perfil</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="Ruleta.html">Ruleta</a></li>
      </ul>

      <div class="ms-auto d-flex align-items-center gap-3 flex-wrap justify-content-end">
        <div class="d-flex align-items-center gap-2 order-1 order-lg-0">
          <i class="bi bi-sun small text-warning"></i>
          <div class="form-check form-switch mb-0">
            <input class="form-check-input theme-switch" type="checkbox" id="darkModeSwitch">
          </div>
          <i class="bi bi-moon-stars small text-secondary-emphasis"></i>
        </div>

        <div class="dropdown order-0 order-lg-1">
          <button class="btn btn-profile" type="button" id="profileDropdown" data-bs-toggle="dropdown">
            <img src="../img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar me-2" id="navbarAvatar">
            <span class="d-none d-sm-inline user-name" id="navbarUserName">Entrenador</span>
            <i class="bi bi-caret-down-fill ms-1 small d-none d-sm-inline"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown">
            <li class="px-3 py-2">
              <div class="d-flex align-items-center">
                <img src="../img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar me-2" id="dropdownAvatar">
                <div class="min-w-0">
                  <div class="fw-semibold small text-truncate" id="dropdownUserName">Entrenador</div>
                  <div class="text-muted xsmall text-truncate" id="dropdownUserEmail">entrenador@pokemarket.com</div>
                </div>
              </div>
            </li>
            <li><hr class="dropdown-divider my-1"></li>
            <li><a class="dropdown-item small" href="Perfil.html"><i class="bi bi-person-badge me-2"></i>Ver perfil</a></li>
            <li><a class="dropdown-item small" href="Registro.html"><i class="bi bi-pencil-square me-2"></i>Editar perfil</a></li>
            <li><a class="dropdown-item small" href="InicioSesion.html" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">

    <!-- Header -->
    <section class="roulette-header text-center mb-3">
      <h1 class="h3 fw-bold mb-2">Ruletas PokeMarket</h1>
      <p class="small text-muted mb-0">
        Elige tu ruleta y convierte tus créditos en <span class="text-warning fw-semibold">drops insanos</span>.
      </p>
    </section>

    <!-- Botón comprar créditos -->
    <div class="d-flex justify-content-center mb-3">
      <a href="Tienda.html" class="btn btn-buy-credits">
        <span class="btn-buy-credits-glow"></span>
        <i class="bi bi-plus-circle-fill me-2"></i>Comprar créditos
      </a>
    </div>

    <!-- Selector de ruletas -->
    <section class="roulette-selector mb-4">
      <div class="row g-3">
        <!-- Común -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card active" data-wheel="common">
            <div class="roulette-choice-badge">Básica</div>
            <h2 class="h6 mb-1">Ruleta Común</h2>
            <p class="xsmall mb-2 text-muted">Solo cartas hasta Rara. Perfecta para farmear barato.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Común–Rara</li>
              <li>Coste: 20 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">20<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis xsmall">Baja inversión</span>
            </div>
          </article>
        </div>

        <!-- Intermedia -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card" data-wheel="mid">
            <div class="roulette-choice-badge">Progresión</div>
            <h2 class="h6 mb-1">Ruleta Intermedia</h2>
            <p class="xsmall mb-2 text-muted">Mezcla de cartas hasta Super rara.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Común–Super rara</li>
              <li>Coste: 40 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">40<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-info-subtle text-info-emphasis xsmall">Mejor media</span>
            </div>
          </article>
        </div>

        <!-- Avanzada -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card" data-wheel="advanced">
            <div class="roulette-choice-badge">Plus</div>
            <h2 class="h6 mb-1">Ruleta Avanzada</h2>
            <p class="xsmall mb-2 text-muted">Infrecuente a Élite. Menos morralla.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Infrecuente–Élite</li>
              <li>Coste: 80 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">80<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-primary-subtle text-primary-emphasis xsmall">Valor constante</span>
            </div>
          </article>
        </div>

        <!-- Experta -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card" data-wheel="expert">
            <div class="roulette-choice-badge">High roll</div>
            <h2 class="h6 mb-1">Ruleta Experta</h2>
            <p class="xsmall mb-2 text-muted">Rara a Épica. Buscando cartas fuertes.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Rara–Épica</li>
              <li>Coste: 120 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">120<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-warning-subtle text-warning-emphasis xsmall">High risk</span>
            </div>
          </article>
        </div>

        <!-- Mítica -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card" data-wheel="mythic">
            <div class="roulette-choice-badge">Endgame</div>
            <h2 class="h6 mb-1">Ruleta Mítica</h2>
            <p class="xsmall mb-2 text-muted">Super rara a Mítica/Legendaria.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Super rara–Legendaria</li>
              <li>Coste: 200 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">200<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-danger-subtle text-danger-emphasis xsmall">Muy volátil</span>
            </div>
          </article>
        </div>

        <!-- Legendaria -->
        <div class="col-12 col-md-6 col-xl-4">
          <article class="roulette-choice-card legendary" data-wheel="legendary">
            <div class="roulette-choice-badge">Insana</div>
            <h2 class="h6 mb-1">Ruleta Legendaria</h2>
            <p class="xsmall mb-2 text-muted">Élite a Legendaria. Más probabilidad de oro.</p>
            <ul class="roulette-choice-tags xsmall mb-2">
              <li>Rangos: Élite–Legendaria</li>
              <li>Coste: 400 créditos</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center">
              <span class="roulette-choice-price">400<span class="xsmall ms-1">créditos</span></span>
              <span class="badge bg-warning-subtle text-warning-emphasis xsmall">Solo valientes</span>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- RULETA + panel derecha -->
    <div class="row g-4 align-items-start">

      <!-- RULETA -->
      <div class="col-lg-8">
        <section class="roulette-card card border-0 shadow-lg rounded-4">
          <div class="card-header border-0 roulette-card-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge bg-danger-subtle text-danger-emphasis xsmall me-2">
                  <i class="bi bi-lightning-charge-fill me-1"></i>Ruleta activa
                </span>
                <span class="badge bg-warning-subtle text-warning-emphasis xsmall">
                  Boost x1.5 en épicas y superiores
                </span>
              </div>
              <div class="text-end">
                <span class="xsmall text-muted d-block">Balance</span>
                <span class="small fw-semibold text-success" id="balanceCredits">1250</span>
                <span class="xsmall text-muted">créditos</span>
              </div>
            </div>
          </div>

          <div class="card-body roulette-body">
            <!-- Rarezas -->
            <div class="roulette-rarities d-flex flex-wrap justify-content-between align-items-center mb-3">
              <div class="rarity-pill rarity-1"><span class="rarity-color-dot"></span>Común</div>
              <div class="rarity-pill rarity-2"><span class="rarity-color-dot"></span>Infrecuente</div>
              <div class="rarity-pill rarity-3"><span class="rarity-color-dot"></span>Rara</div>
              <div class="rarity-pill rarity-4"><span class="rarity-color-dot"></span>Super rara</div>
              <div class="rarity-pill rarity-5"><span class="rarity-color-dot"></span>Élite</div>
              <div class="rarity-pill rarity-6"><span class="rarity-color-dot"></span>Épica</div>
              <div class="rarity-pill rarity-7"><span class="rarity-color-dot"></span>Mítica</div>
              <div class="rarity-pill rarity-8"><span class="rarity-color-dot"></span>Legendaria</div>
            </div>

            <!-- Ventana ruleta -->
            <div class="roulette-window-wrapper mb-3">
              <div class="roulette-highlight"></div>
              <div class="roulette-window">
                <div class="roulette-strip" id="rouletteStrip"></div>
              </div>
              <div class="roulette-bottom-glow"></div>
            </div>

            <!-- Resultado -->
            <div class="roulette-result text-center mb-3" id="rouletteResult">
              <span class="small text-info">
                <i class="bi bi-dice-5 me-1"></i>Cargando cartas TCG...
              </span>
            </div>

            <!-- Controles -->
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="d-flex align-items-center gap-1">
                  <span class="xsmall text-muted">Auto giros:</span>
                  <select class="form-select form-select-sm roulette-autospins-select" id="autoCount">
                    <option value="5">5 giros</option>
                    <option value="10" selected>10 giros</option>
                    <option value="15">15 giros</option>
                    <option value="20">20 giros</option>
                    <option value="25">25 giros</option>
                    <option value="30">30 giros (MAX)</option>
                  </select>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="btnAuto" disabled>
                    <i class="bi bi-arrow-repeat me-1"></i>Auto giros
                  </button>
                  <button class="btn btn-outline-danger btn-sm d-none" type="button" id="btnStopAuto">
                    <i class="bi bi-stop-circle me-1"></i>Parar
                  </button>
                </div>
              </div>

              <div class="text-end">
                <div class="xsmall text-muted mb-1">
                  Coste por giro:
                  <span class="text-warning fw-semibold" id="spinCost">20</span> créditos
                </div>
                <button class="btn btn-poke btn-lg fw-semibold" id="btnSpin" disabled>
                  <i class="bi bi-dice-5 me-1"></i>Girar 1 vez
                </button>
              </div>
            </div>
          </div>

          <div class="card-footer border-0 roulette-footer xsmall text-muted">
            Los objetos ganados se añaden automáticamente a tu colección. Puedes gestionarlos desde la página de <a href="Coleccion.html" class="text-warning text-decoration-none fw-semibold">Colección</a>.
          </div>
        </section>
      </div>

      <!-- PANEL DERECHA -->
      <div class="col-lg-4">
        <section class="card border-0 shadow-sm rounded-4 mb-3">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-graph-up-arrow me-1"></i>Probabilidades base</h2>
            <ul class="list-unstyled mb-0 xsmall" id="baseProbList"></ul>
          </div>
        </section>

        <section class="card border-0 shadow-sm rounded-4 mb-3">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-activity me-1"></i>Porcentajes actuales</h2>
            <p class="xsmall text-muted">Basado en los últimos giros de esta ruleta.</p>
            <ul class="list-unstyled mb-0 xsmall" id="currentProbList"></ul>
          </div>
        </section>

        <section class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-2"><i class="bi bi-trophy-fill text-warning me-1"></i>Últimas cartas ganadas</h2>
            <ul class="list-unstyled mb-0 xsmall" id="lastDrops"></ul>
          </div>
        </section>
      </div>
    </div>

    <p class="roulette-disclaimer text-center mt-4">
      Probabilidades fijas por rareza y por ruleta. Juega con responsabilidad.
    </p>

  </div>
</main>

<!-- Toast notificaciones -->
<div class="roulette-toast-container" id="toastContainer"></div>

<!-- Modal recompensa carta -->
<div class="modal fade reward-modal" id="rewardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content reward-modal-content">
      <div class="reward-glow"></div>
      <div class="reward-rays"></div>
      <div class="modal-body text-center">
        <p class="xsmall text-muted mb-1">¡Nueva recompensa!</p>
        <h2 class="h5 fw-bold mb-2" id="rewardTitle">Has conseguido una carta</h2>

        <div class="reward-card-wrapper">
          <div class="reward-card-inner">
            <img id="rewardImage" src="" alt="Carta obtenida">
          </div>
        </div>

        <p class="mt-2 mb-1">
          <span class="badge" id="rewardRarityBadge">Épica</span>
        </p>
        <p class="small text-muted mb-0" id="rewardSetName"></p>

        <div class="mt-3 d-flex justify-content-center gap-2">
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
            Seguir girando
          </button>
          <a href="Coleccion.html" class="btn btn-warning btn-sm" id="btnGoCollection">
            Ir a colección
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const html = document.documentElement;
  const switchElement = document.getElementById('darkModeSwitch');

  const savedTheme = localStorage.getItem('bsTheme') || 'light';
  html.setAttribute('data-bs-theme', savedTheme);
  if (switchElement) {
    switchElement.checked = savedTheme === 'dark';
    switchElement.addEventListener('change', function () {
      const theme = this.checked ? 'dark' : 'light';
      html.setAttribute('data-bs-theme', theme);
      localStorage.setItem('bsTheme', theme);
    });
  }

  const defaultName   = 'Entrenador';
  const defaultEmail  = 'entrenador@pokemarket.com';
  const defaultAvatar = '../img/avatars/pokeball.png';

  const name   = localStorage.getItem('pm_user_name')   || defaultName;
  const email  = localStorage.getItem('pm_user_email')  || defaultEmail;
  const avatar = localStorage.getItem('pm_user_avatar') || defaultAvatar;

  const navbarUserName    = document.getElementById('navbarUserName');
  const dropdownUserName  = document.getElementById('dropdownUserName');
  const dropdownUserEmail = document.getElementById('dropdownUserEmail');
  const navbarAvatar      = document.getElementById('navbarAvatar');
  const dropdownAvatar    = document.getElementById('dropdownAvatar');

  if (navbarUserName)    navbarUserName.textContent = name;
  if (dropdownUserName)  dropdownUserName.textContent = name;
  if (dropdownUserEmail) dropdownUserEmail.textContent = email;
  if (navbarAvatar)      navbarAvatar.src = avatar;
  if (dropdownAvatar)    dropdownAvatar.src = avatar;

  const logoutLink = document.getElementById('logoutLink');
  if (logoutLink) {
    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('pm_user_name');
      localStorage.removeItem('pm_user_email');
      localStorage.removeItem('pm_user_avatar');
      localStorage.removeItem('pm_user_bio');
      localStorage.removeItem('pm_cards_sale');
      localStorage.removeItem('pm_collection');
      window.location.href = 'InicioSesion.html';
    });
  }

  const rarityDefs = [
    { id: 1, key: 'common',    label: 'Común' },
    { id: 2, key: 'uncommon',  label: 'Infrecuente' },
    { id: 3, key: 'rare',      label: 'Rara' },
    { id: 4, key: 'superrare', label: 'Super rara' },
    { id: 5, key: 'elite',     label: 'Élite' },
    { id: 6, key: 'epic',      label: 'Épica' },
    { id: 7, key: 'mythic',    label: 'Mítica' },
    { id: 8, key: 'legendary', label: 'Legendaria' }
  ];

  const wheelsConfig = {
    common: {
      name: 'Ruleta Común',
      cost: 20,
      probs: {
        common: 0.70,
        uncommon: 0.25,
        rare: 0.05
      }
    },
    mid: {
      name: 'Ruleta Intermedia',
      cost: 40,
      probs: {
        common: 0.45,
        uncommon: 0.30,
        rare: 0.15,
        superrare: 0.07,
        elite: 0.03
      }
    },
    advanced: {
      name: 'Ruleta Avanzada',
      cost: 80,
      probs: {
        uncommon: 0.35,
        rare: 0.30,
        superrare: 0.18,
        elite: 0.12,
        epic: 0.05
      }
    },
    expert: {
      name: 'Ruleta Experta',
      cost: 120,
      probs: {
        rare: 0.35,
        superrare: 0.28,
        elite: 0.18,
        epic: 0.12,
        mythic: 0.07
      }
    },
    mythic: {
      name: 'Ruleta Mítica',
      cost: 200,
      probs: {
        superrare: 0.30,
        elite: 0.27,
        epic: 0.20,
        mythic: 0.22,
        legendary: 0.01
      }
    },
    legendary: {
      name: 'Ruleta Legendaria',
      cost: 400,
      probs: {
        elite: 0.38,
        epic: 0.31,
        mythic: 0.28,
        legendary: 0.03
      }
    }
  };

  const TCG_API_BASE = 'http://localhost:3000/api/cards';

  // Hash FNV-1a simple para distribuir ids mejor
  function fnv1aHash(str) {
    let hash = 2166136261 >>> 0;
    for (let i = 0; i < str.length; i++) {
      hash ^= str.charCodeAt(i);
      hash = Math.imul(hash, 16777619) >>> 0;
    }
    return hash >>> 0;
  }

  // Rareza interna: si hay precio se usa, si no, hash determinista del id
  function mapApiRarityToInternal(card) {
    const price = card.priceEur ?? null;
    if (price !== null) {
      if (price >= 80) return 'legendary';
      if (price >= 40) return 'mythic';
      if (price >= 20) return 'epic';
      if (price >= 10) return 'elite';
      if (price >= 5)  return 'superrare';
      if (price >= 2)  return 'rare';
      if (price >= 1)  return 'uncommon';
      return 'common';
    }

    const id = String(card.id || '');
    const hash = fnv1aHash(id);
    const r = (hash % 10000) / 10000; // 0.0000–0.9999

    if (r < 0.5500) return 'common';
    if (r < 0.7500) return 'uncommon';
    if (r < 0.8500) return 'rare';
    if (r < 0.9100) return 'superrare';
    if (r < 0.9500) return 'elite';
    if (r < 0.9800) return 'epic';
    if (r < 0.9950) return 'mythic';
    return 'legendary';
  }

  const cardsByRarity = {
    common: [], uncommon: [], rare: [],
    superrare: [], elite: [], epic: [], mythic: [], legendary: []
  };
  window.cardsByRarity = cardsByRarity;

  async function loadAllCardsFromApi(maxPages = 40) {
    let currentPage = 1;

    while (true) {
      const url = `${TCG_API_BASE}?page=${currentPage}&pageSize=50`;
      console.log('Cargando página', currentPage, url);

      const res = await fetch(url);
      if (!res.ok) {
        console.error('Error HTTP al cargar cartas:', res.status);
        break;
      }

      const data = await res.json();
      const cards = data.data || [];
      const count = data.count || cards.length;

      cards.forEach(card => {
        const internalRarity = mapApiRarityToInternal(card);
        if (!cardsByRarity[internalRarity]) return;

        cardsByRarity[internalRarity].push({
          id: card.id,
          name: card.name,
          image: card.imageUrl || '',
          apiRarity: card.apiRarity || '',
          setName: card.setName || '',
          types: [],
          holographic: false,
          priceEur: card.priceEur ?? null,
          priceUsd: null
        });
      });

      console.log(`Página ${currentPage} -> ${count} cartas.`);

      if (!cards.length) break;

      currentPage++;
      if (currentPage > maxPages) break;
    }

    console.log('Totales por rareza:', {
      common: cardsByRarity.common.length,
      uncommon: cardsByRarity.uncommon.length,
      rare: cardsByRarity.rare.length,
      superrare: cardsByRarity.superrare.length,
      elite: cardsByRarity.elite.length,
      epic: cardsByRarity.epic.length,
      mythic: cardsByRarity.mythic.length,
      legendary: cardsByRarity.legendary.length
    });
  }

  const rouletteStrip = document.getElementById('rouletteStrip');
  const btnSpin = document.getElementById('btnSpin');
  const btnAuto = document.getElementById('btnAuto');
  const btnStopAuto = document.getElementById('btnStopAuto');
  const autoCountSelect = document.getElementById('autoCount');
  const resultBox = document.getElementById('rouletteResult');
  const lastDropsList = document.getElementById('lastDrops');
  const currentProbList = document.getElementById('currentProbList');
  const baseProbList = document.getElementById('baseProbList');
  const balanceEl = document.getElementById('balanceCredits');
  const spinCostEl = document.getElementById('spinCost');
  const toastContainer = document.getElementById('toastContainer');
  const wheelCards = document.querySelectorAll('.roulette-choice-card');
  const btnGoCollection = document.getElementById('btnGoCollection');

  if (btnGoCollection) {
    btnGoCollection.addEventListener('click', () => {
      window.location.href = 'Coleccion.html';
    });
  }

  if (!rouletteStrip || !btnSpin) return;

  let balance = 1250;
  let currentWheelKey = 'common';
  let spinCost = wheelsConfig[currentWheelKey].cost;
  let lastSpinCard = null;

  if (balanceEl) balanceEl.textContent = balance.toString();
  if (spinCostEl) spinCostEl.textContent = spinCost.toString();

  function updateSpinCostUI() {
    spinCost = wheelsConfig[currentWheelKey].cost;
    if (spinCostEl) spinCostEl.textContent = spinCost.toString();
  }

  function updateBaseProbabilitiesUI() {
    if (!baseProbList) return;
    baseProbList.innerHTML = '';
    const cfg = wheelsConfig[currentWheelKey];
    const probs = cfg.probs;
    const keys = Object.keys(probs);

    keys.forEach(k => {
      const rd = rarityDefs.find(r => r.key === k);
      const li = document.createElement('li');
      li.className = 'd-flex justify-content-between';
      li.innerHTML = `
        <span>${rd.label}</span>
        <span class="text-muted">${(probs[k] * 100).toFixed(1)} %</span>
      `;
      baseProbList.appendChild(li);
    });
  }

  function pickRarity() {
    const cfg = wheelsConfig[currentWheelKey];
    const probs = cfg.probs;
    const entries = Object.entries(probs);

    const total = entries.reduce((sum, [, p]) => sum + p, 0);
    const r = Math.random() * total;
    let acc = 0;
    for (const [key, p] of entries) {
      acc += p;
      if (r <= acc) return rarityDefs.find(rd => rd.key === key);
    }
    const fallbackKey = entries[0][0];
    return rarityDefs.find(rd => rd.key === fallbackKey);
  }

  function pickCard() {
    const rarity = pickRarity();
    const pool = cardsByRarity[rarity.key] || [];

    if (!pool.length) {
      return {
        id: null,
        name: 'Carta desconocida',
        image: '',
        rarity,
        rarityInternal: rarity.key,
        apiRarity: '',
        setName: '',
        types: [],
        holographic: false,
        priceEur: null,
        priceUsd: null
      };
    }

    const base = pool[Math.floor(Math.random() * pool.length)];
    return {
      ...base,
      rarity,
      rarityInternal: rarity.key
    };
  }

  function createItem(card) {
    const item = document.createElement('div');
    item.className = 'roulette-item rarity-' + card.rarity.key;
    item.innerHTML = `
      <div class="roulette-item-inner">
        <div class="roulette-item-rarity mb-1">${card.rarity.label}</div>
        <div class="d-flex align-items-center gap-2">
          ${card.image ? `<img src="${card.image}" class="roulette-item-image" alt="${card.name}">` : ''}
          <div class="roulette-item-name text-truncate">${card.name}</div>
        </div>
      </div>
    `;
    return item;
  }

  function fillStrip(winnerCard) {
    rouletteStrip.innerHTML = '';
    const totalItems = 80;
    const winnerIndex = Math.floor(totalItems / 2) + 4;

    for (let i = 0; i < totalItems; i++) {
      const card = (i === winnerIndex && winnerCard) ? winnerCard : pickCard();
      const item = createItem(card);
      if (i === winnerIndex) {
        item.dataset.winner = 'true';
      }
      rouletteStrip.appendChild(item);
    }
    rouletteStrip.style.transform = 'translateX(0px)';
  }

  function addCardToCollection(card) {
    const raw = localStorage.getItem('pm_collection') || '[]';
    let collection;
    try {
      collection = JSON.parse(raw);
      if (!Array.isArray(collection)) collection = [];
    } catch {
      collection = [];
    }

    collection.push({
      id: card.id || null,
      name: card.name,
      rarityInternal: card.rarityInternal || card.rarity?.key || null,
      rarityLabel: card.rarity?.label || '',
      image: card.image || '',
      apiRarity: card.apiRarity || '',
      setName: card.setName || '',
      types: card.types || [],
      holographic: !!card.holographic,
      priceEur: card.priceEur ?? null,
      priceUsd: card.priceUsd ?? null,
      obtainedAt: new Date().toISOString()
    });

    localStorage.setItem('pm_collection', JSON.stringify(collection));
  }

  const statsByWheel = {};
  const totalSpinsByWheel = {};
  Object.keys(wheelsConfig).forEach(key => {
    statsByWheel[key] = {};
    rarityDefs.forEach(rd => { statsByWheel[key][rd.key] = 0; });
    totalSpinsByWheel[key] = 0;
  });

  function updateCurrentProbabilities() {
    if (!currentProbList) return;
    currentProbList.innerHTML = '';
    const wheelKey = currentWheelKey;
    const total = totalSpinsByWheel[wheelKey] || 0;

    if (total === 0) {
      const li = document.createElement('li');
      li.textContent = 'Aún no hay datos para esta ruleta. Gira para empezar.';
      currentProbList.appendChild(li);
      return;
    }

    const cfg = wheelsConfig[wheelKey];
    const allowedKeys = Object.keys(cfg.probs);

    allowedKeys.forEach(k => {
      const rd = rarityDefs.find(r => r.key === k);
      const count = statsByWheel[wheelKey][k] || 0;
      const perc = (count / total) * 100;
      const li = document.createElement('li');
      li.className = 'd-flex justify-content-between mb-1';
      li.innerHTML = `
        <span>${rd.label}</span>
        <span class="${rd.id >= 6 ? 'text-warning fw-semibold' : ''}">${perc.toFixed(1)} %</span>
      `;
      currentProbList.appendChild(li);
    });
  }

  function pushLastDrop(card) {
    if (!lastDropsList) return;
    const li = document.createElement('li');
    li.className = 'd-flex justify-content-between mb-1';
    const rarityClass =
      card.rarity.id >= 8 ? 'bg-warning-subtle text-warning-emphasis' :
      card.rarity.id >= 6 ? 'bg-info-subtle text-info-emphasis' :
      'bg-primary-subtle text-primary-emphasis';
    li.innerHTML = `
      <span class="text-truncate me-2">${card.name}</span>
      <span class="badge ${rarityClass}">${card.rarity.label}</span>
    `;
    lastDropsList.prepend(li);
    while (lastDropsList.children.length > 8) {
      lastDropsList.removeChild(lastDropsList.lastElementChild);
    }
  }

  function showToast(card) {
    if (!toastContainer) return;
    const toast = document.createElement('div');
    toast.className = 'roulette-toast';
    toast.innerHTML = `
      <div class="roulette-toast-inner rarity-${card.rarityInternal || card.rarity.key}">
        <div class="roulette-toast-title">
          <i class="bi bi-stars me-1"></i>¡Nueva carta!
        </div>
        <div class="roulette-toast-body">
          <span class="fw-semibold">${card.name}</span>
          <span class="xsmall ms-1 text-muted">(${card.rarity.label})</span>
        </div>
      </div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 10);

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  let spinning = false;
  let autoMode = false;
  let autoSpinsLeft = 0;

  function doSpin(callback) {
    if (spinning) {
      if (callback) callback();
      return;
    }
    if (balance < spinCost) {
      if (resultBox) {
        resultBox.innerHTML = '<span class="small text-danger">No tienes créditos suficientes.</span>';
      }
      if (callback) callback();
      return;
    }

    balance -= spinCost;
    if (balanceEl) balanceEl.textContent = balance.toString();

    lastSpinCard = pickCard();

    spinning = true;
    fillStrip(lastSpinCard);

    const items = Array.from(rouletteStrip.children);
    if (!items.length) {
      spinning = false;
      if (callback) callback();
      return;
    }

    const winnerIndex = items.findIndex(el => el.dataset.winner === 'true');
    const finalIndex = winnerIndex === -1 ? Math.floor(items.length / 2) : winnerIndex;

    const itemRect = items[0].getBoundingClientRect();
    const itemWidth = itemRect.width + 4;
    const windowWidth = rouletteStrip.parentElement.getBoundingClientRect().width;
    const targetCenter = finalIndex * itemWidth + itemWidth / 2;
    const offset = targetCenter - windowWidth / 2;

    const duration = 3200; // más largo, más suave
    const startX = 0;
    const endX = Math.max(offset, 0);
    const startTime = performance.now();

    function animate(now) {
      const t = Math.min(1, (now - startTime) / duration);
      const ease = 1 - Math.pow(1 - t, 4); // easeOutQuart
      const current = startX + (endX - startX) * ease;
      rouletteStrip.style.transform = `translateX(-${current}px)`;
      rouletteStrip.style.setProperty('--roulette-offset', `-${current}px`);

      if (t < 1 && spinning) {
        requestAnimationFrame(animate);
      } else {
        finishSpin(finalIndex, items, callback);
      }
    }

    if (resultBox) {
      resultBox.innerHTML = '<span class="small text-info"><i class="bi bi-dice-5 me-1"></i>Girando...</span>';
    }

    requestAnimationFrame(animate);
  }

  function finishSpin(finalIndex, items, callback) {
    const card = lastSpinCard || pickCard();

    const wheelKey = currentWheelKey;
    statsByWheel[wheelKey][card.rarity.key] += 1;
    totalSpinsByWheel[wheelKey] += 1;
    updateCurrentProbabilities();
    pushLastDrop(card);
    showToast(card);
    addCardToCollection(card);

    let extra = '';
    if (card.rarity.id >= 8) {
      extra = ' <span class="text-warning fw-bold">DROP LEGENDARIO INSANO</span>';
    } else if (card.rarity.id >= 7) {
      extra = ' <span class="text-warning fw-semibold">¡Mítica!</span>';
    } else if (card.rarity.id >= 6) {
      extra = ' <span class="text-info fw-semibold">Épica sólida.</span>';
    }

    if (resultBox) {
      resultBox.innerHTML = `
        <span class="small">
          Resultado: <span class="fw-semibold text-${card.rarity.id >= 7 ? 'warning' : (card.rarity.id >= 5 ? 'info' : 'success')}">
            ${card.name}
          </span> <span class="xsmall text-muted">(${card.rarity.label})</span>${extra}
        </span>
      `;
    }

    // Modal dopamina
    const rewardModalEl = document.getElementById('rewardModal');
    if (rewardModalEl) {
      const rewardImage = document.getElementById('rewardImage');
      const rewardTitle = document.getElementById('rewardTitle');
      const rewardRarityBadge = document.getElementById('rewardRarityBadge');
      const rewardSetName = document.getElementById('rewardSetName');

      if (rewardImage) {
        rewardImage.src = card.image || '../img/avatars/pokeball.png';
      }
      if (rewardTitle) {
        rewardTitle.textContent = card.name || 'Carta desconocida';
      }
      if (rewardRarityBadge) {
        rewardRarityBadge.textContent = card.rarity.label;
        rewardRarityBadge.className = 'badge';
        if (card.rarity.id >= 8) {
          rewardRarityBadge.classList.add('bg-warning', 'text-dark');
        } else if (card.rarity.id >= 6) {
          rewardRarityBadge.classList.add('bg-info', 'text-dark');
        } else if (card.rarity.id >= 4) {
          rewardRarityBadge.classList.add('bg-primary');
        } else {
          rewardRarityBadge.classList.add('bg-secondary');
        }
      }
      if (rewardSetName) {
        rewardSetName.textContent = card.setName ? `Set: ${card.setName}` : '';
      }

      const modal = new bootstrap.Modal(rewardModalEl);
      modal.show();
    }

    spinning = false;
    if (callback) callback();
  }

  btnSpin.addEventListener('click', () => {
    if (autoMode) return;
    doSpin();
  });

  function updateAutoButtons() {
    if (autoMode) {
      btnAuto.classList.add('disabled');
      btnStopAuto.classList.remove('d-none');
      btnStopAuto.disabled = false;
      btnSpin.disabled = true;
    } else {
      btnAuto.classList.remove('disabled');
      btnStopAuto.classList.add('d-none');
      btnSpin.disabled = false;
    }
  }

  function runNextAuto() {
    if (!autoMode || autoSpinsLeft <= 0) {
      autoMode = false;
      updateAutoButtons();
      return;
    }
    autoSpinsLeft--;
    doSpin(() => {
      if (!autoMode) return;
      setTimeout(runNextAuto, 280);
    });
  }

  btnAuto.addEventListener('click', () => {
    if (autoMode || spinning) return;
    const count = parseInt(autoCountSelect.value, 10) || 10;
    autoSpinsLeft = count;
    autoMode = true;
    updateAutoButtons();
    runNextAuto();
  });

  btnStopAuto.addEventListener('click', () => {
    autoMode = false;
    autoSpinsLeft = 0;
    updateAutoButtons();
  });

  wheelCards.forEach(card => {
    card.addEventListener('click', () => {
      if (autoMode || spinning) return;

      wheelCards.forEach(c => c.classList.remove('active'));
      card.classList.add('active');

      const key = card.getAttribute('data-wheel');
      if (!wheelsConfig[key]) return;
      currentWheelKey = key;
      updateSpinCostUI();
      updateBaseProbabilitiesUI();
      updateCurrentProbabilities();

      if (resultBox) {
        const cfg = wheelsConfig[key];
        const keys = Object.keys(cfg.probs);
        const minKey = keys[0];
        const maxKey = keys[keys.length - 1];
        const minLabel = rarityDefs.find(r => r.key === minKey).label;
        const maxLabel = rarityDefs.find(r => r.key === maxKey).label;
        resultBox.innerHTML = `
          <span class="xsmall text-muted">
            Ruleta seleccionada: <span class="fw-semibold">${cfg.name}</span>.
            Rangos: ${minLabel} – ${maxLabel}.
          </span>
        `;
      }
    });
  });

  await loadAllCardsFromApi(40);

  btnSpin.disabled = false;
  btnAuto.disabled = false;
  if (resultBox) {
    resultBox.innerHTML = `
      <span class="small text-info">
        <i class="bi bi-dice-5 me-1"></i>Cartas TCG cargadas. Elige ruleta o tira 1 vez.
      </span>
    `;
  }

  fillStrip();
  updateSpinCostUI();
  updateBaseProbabilitiesUI();
  updateCurrentProbabilities();
});
</script>

</body>
</html>
