<!doctype html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <title>PokeMarket - Perfil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- CSS global -->
  <link rel="stylesheet" href="../CSS/style.css">
</head>

<body class="bg-pokeballs">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-main sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2 mb-0" href="../Home.html">
        <div class="pokeball-logo rounded-circle" style="width:32px;height:32px;"></div>
        <span class="brand-text">PokeMarket</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
        aria-controls="mainNavbar" aria-expanded="false" aria-label="Mostrar navegación">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav ms-3">
          <li class="nav-item">
            <a class="nav-link" href="../Home.html">Inicio</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="Colección.html">Colección</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="Perfil.html">Perfil</a>
          </li>
        </ul>

        <div class="ms-auto d-flex align-items-center gap-3 flex-wrap justify-content-end">
          <!-- Créditos -->
          <div class="d-flex align-items-center gap-1" id="globalCredits">
            <i class="bi bi-coin text-warning"></i>
            <span class="fw-bold" id="navbarCredits">0</span>
          </div>

          <!-- Dropdown perfil -->
          <div class="dropdown">
            <button class="btn btn-outline-light btn-profile rounded-pill d-flex align-items-center gap-2 px-3"
              type="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="img/avatars/pokeball.png" alt="Avatar" class="avatar-50 rounded-circle" id="navbarAvatar">
              <span class="d-none d-sm-inline user-name" id="navbarUserName">
                Entrenador
              </span>
              <i class="bi bi-caret-down-fill small d-none d-sm-inline"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown">
              <li class="px-3 py-2">
                <div class="d-flex align-items-center">
                  <img src="img/avatars/pokeball.png" alt="Avatar"
                    class="avatar-50 rounded-circle border me-2" id="dropdownAvatar">
                  <div class="min-w-0">
                    <div class="fw-semibold small text-truncate" id="dropdownUserName">Entrenador</div>
                    <div class="text-muted" style="font-size:0.7rem" id="dropdownUserEmail">
                      entrenador@pokemarket.com
                    </div>
                  </div>
                </div>
              </li>
              <li><hr class="dropdown-divider my-1"></li>
              <li>
                <a class="dropdown-item small" href="Perfil.html">
                  <i class="bi bi-person-badge me-2"></i>Ver perfil
                </a>
              </li>
              <li>
                <a class="dropdown-item small" href="InicioSesion.html" id="logoutLink">
                  <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                </a>
              </li>
            </ul>
          </div>

        </div>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PERFIL -->
  <main class="py-4">
    <div class="container">

      <!-- CABECERA PERFIL -->
      <section class="card border-0 shadow-sm mb-4 rounded-3 profile-header-animated">
        <div class="card-body p-3">
          <div class="row g-3 align-items-center">
            <!-- Avatar grande -->
            <div class="col-auto">
              <div class="rounded-circle border border-3 p-1 bg-dark d-flex align-items-center justify-content-center">
                <img src="img/avatars/pokeball.png" alt="Avatar perfil"
                  class="avatar-50 rounded-circle" id="profileAvatar">
              </div>
            </div>

            <!-- Nombre + bio + acciones -->
            <div class="col">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                <h1 class="h4 mb-0 me-2" id="profileName">Entrenador</h1>
                <span class="badge bg-secondary text-light bg-poke-username">@entrenador</span>
              </div>

              <p class="mb-2 text-muted small" id="profileEmail">
                entrenador@pokemarket.com
              </p>

              <p class="mb-3 small" id="profileBio" style="max-width:480px;">
                Coleccionista de cartas Pokémon, cazador de grails y adicto a las ruletas legendarias.
              </p>

              <div class="d-flex flex-wrap align-items-center gap-4 mb-3">
                <div class="d-flex flex-column">
                  <span class="fw-bold" id="statCartasVenta">0</span>
                  <span class="small text-muted">Cartas en venta</span>
                </div>
                <div class="d-flex flex-column">
                  <span id="statSeguidores" class="fw-bold">0</span>
                  <span class="small text-muted">Seguidores</span>
                </div>
                <div class="d-flex flex-column">
                  <span id="statSiguiendo" class="fw-bold">0</span>
                  <span class="small text-muted">Siguiendo</span>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 align-items-center">
                <button class="btn btn-warning btn-sm fw-semibold rounded-pill" data-bs-toggle="modal"
                  data-bs-target="#editarPerfilModal">
                  <i class="bi bi-pencil-square me-1"></i>Editar perfil
                </button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="offcanvas"
                  data-bs-target="#shareProfileSheet">
                  <i class="bi bi-share me-1"></i>Compartir perfil
                </button>

                <div class="ms-auto ms-lg-3">
                  <div class="input-group input-group-sm rounded-pill" style="max-width:240px;">
                    <span class="input-group-text xsmall">
                      <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control form-control-sm xsmall" id="profileCardSearch"
                      placeholder="Buscar carta en tu perfil...">
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- TABS PERFIL -->
      <section class="card border-0 shadow-sm rounded-3 profile-tabs-animated">
        <div class="card-header border-0 bg-transparent">
          <ul class="nav nav-pills gap-2" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="venta-tab" data-bs-toggle="pill" data-bs-target="#tab-venta"
                type="button" role="tab" aria-controls="tab-venta" aria-selected="true">
                <i class="bi bi-shop-window me-1"></i>En venta
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="favoritas-tab" data-bs-toggle="pill" data-bs-target="#tab-favoritas"
                type="button" role="tab" aria-controls="tab-favoritas" aria-selected="false">
                <i class="bi bi-heart-fill me-1"></i>Favoritas
              </button>
            </li>
          </ul>
        </div>

        <div class="card-body">
          <div class="tab-content" id="profileTabsContent">
            <!-- TAB EN VENTA -->
            <div class="tab-pane fade show active" id="tab-venta" role="tabpanel" aria-labelledby="venta-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h6 mb-0">Cartas en venta</h2>
                <button class="btn btn-warning btn-sm fw-semibold rounded-pill profile-btn-animated"
                  data-bs-toggle="modal" data-bs-target="#selectCollectionCardModal">
                  <i class="bi bi-plus-lg me-1"></i>Añadir carta
                </button>
              </div>
              <div class="row g-3" id="gridCartasVenta">
                <div class="col-6 col-md-4 col-lg-3 d-none" id="plantillaCartaVenta">
                  <article class="card h-100 border-0 card-perfil-venta card-perfil-venta-clickable">
                    <div class="card-carta-frame bg-dark d-flex align-items-center justify-content-center">
                      <img src="" alt="Carta" class="carta-img"
                        style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <div class="card-body p-2">
                      <div class="d-flex justify-content-between align-items-start mb-1">
                        <h3 class="card-title mb-0 small carta-nombre text-truncate">Nombre carta</h3>
                        <span class="badge xsmall carta-rareza-badge">R</span>
                      </div>
                      <p class="mb-1 xsmall text-muted carta-rareza">Rareza</p>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-semibold carta-precio small">0,00 €</span>
                        <span class="xsmall text-muted carta-obtenida">-</span>
                      </div>
                    </div>
                  </article>
                </div>
                <p class="text-muted small mb-0" id="textoSinCartasVenta">
                  Todavía no has puesto ninguna carta a la venta. Usa el botón “Añadir carta” para empezar.
                </p>
              </div>
            </div>

            <!-- TAB FAVORITAS -->
            <div class="tab-pane fade" id="tab-favoritas" role="tabpanel" aria-labelledby="favoritas-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h6 mb-0">Cartas favoritas</h2>
                <button class="btn btn-sm btn-outline-secondary profile-btn-ghost" id="btnAddFavorita"
                  data-bs-toggle="modal" data-bs-target="#favoriteSelectModal">
                  <i class="bi bi-heart me-1"></i>Elegir favoritas
                </button>
              </div>
              <div class="row g-3" id="gridFavoritas">
                <p class="text-muted small mb-0" id="textoSinFavoritas">
                  Marca cartas como favoritas para verlas aquí de forma rápida.
                </p>
              </div>
            </div>

          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- MODAL EDITAR PERFIL -->
  <div class="modal fade" id="editarPerfilModal" tabindex="-1" aria-labelledby="editarPerfilModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content profile-modal">
        <div class="modal-header border-0">
          <h1 class="modal-title h5" id="editarPerfilModalLabel">Editar perfil</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="formEditarPerfil" novalidate>
            <div class="mb-3 text-center">
              <div
                class="profile-avatar-wrapper mb-2 mx-auto profile-avatar-glow d-flex align-items-center justify-content-center">
                <img src="img/avatars/pokeball.png" alt="Avatar"
                  class="avatar-50 rounded-circle" id="editarAvatarPreview">
              </div>
              <div class="d-flex justify-content-center gap-2 flex-wrap">
                <label class="btn btn-outline-secondary btn-sm mb-0 profile-btn-ghost">
                  <i class="bi bi-image me-1"></i>Galería
                  <input type="file" class="d-none" id="editarAvatarInput" accept="image/*">
                </label>
                <button type="button" class="btn btn-outline-secondary btn-sm mb-0 profile-btn-ghost"
                  data-bs-toggle="collapse" data-bs-target="#avatarPredeterminadoCollapse" aria-expanded="false"
                  aria-controls="avatarPredeterminadoCollapse">
                  <i class="bi bi-emoji-smile me-1"></i>Avatar predeterminado
                </button>
              </div>
              <div class="collapse mt-3" id="avatarPredeterminadoCollapse">
                <div class="row g-3 justify-content-center">
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/pikachu.jpg" alt="Pikachu"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/pikachu.jpg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/Bulbasaur.jpeg" alt="Bulbasaur"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/Bulbasaur.jpeg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/charmander.jpg" alt="Charmander"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/charmander.jpg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/squirtle.jpg" alt="Squirtle"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/squirtle.jpg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/jigglipuff.jpg" alt="Jigglypuff"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/jigglipuff.jpg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/meowth.jpeg" alt="Meowth"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/meowth.jpeg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/psyduck.jpeg" alt="Psyduck"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/psyduck.jpeg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/snorlax.png" alt="Snorlax"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/snorlax.png">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/eevee.jpg" alt="Eevee"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/eevee.jpg">
                  </div>
                  <div class="col-3 d-flex justify-content-center">
                    <img src="../img/avatars/pokeball.png" alt="Pokeball"
                      class="avatar-50 avatar-select rounded-circle border"
                      data-avatar-default="../img/avatars/pokeball.png">
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="editarNombre" class="form-label small">Nombre</label>
              <input type="text" class="form-control form-control-sm" id="editarNombre" required>
            </div>

            <div class="mb-3">
              <label for="editarBio" class="form-label small">Descripción</label>
              <textarea class="form-control form-control-sm" id="editarBio" rows="3"
                placeholder="Cuenta algo sobre ti como entrenador Pokémon..."></textarea>
            </div>

            <div class="mb-3">
              <label for="editarEmail" class="form-label small">Correo electrónico</label>
              <input type="email" class="form-control form-control-sm" id="editarEmail" required
                placeholder="tunombre@correo.com">
              <div class="invalid-feedback xsmall">
                Introduce un correo electrónico válido.
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning btn-sm fw-semibold rounded-pill"
            id="btnGuardarPerfil">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL SELECCIONAR CARTA (VENTA) -->
  <div class="modal fade" id="selectCollectionCardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content profile-modal">
        <div class="modal-header border-0">
          <h5 class="modal-title h6">
            <i class="bi bi-collection me-1"></i>Seleccionar carta de tu colección
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-md-6">
              <div class="input-group input-group-sm">
                <span class="input-group-text xsmall"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control form-control-sm xsmall" id="saleSearchName"
                  placeholder="Nombre o set">
              </div>
            </div>
            <div class="col-md-3 col-6">
              <select class="form-select form-select-sm xsmall" id="saleSearchRarity">
                <option value="all">Rareza: Todas</option>
                <option value="common">Común</option>
                <option value="uncommon">Infrecuente</option>
                <option value="rare">Rara</option>
                <option value="superrare">Super rara</option>
                <option value="elite">Élite</option>
                <option value="epic">Épica</option>
                <option value="mythic">Mítica</option>
                <option value="legendary">Legendaria</option>
              </select>
            </div>
            <div
              class="col-md-3 col-6 text-end xsmall text-muted d-flex align-items-center justify-content-end">
              <span id="saleSelectorCount">0 resultados</span>
            </div>
          </div>
          <div class="row g-2" id="saleCollectionGrid">
            <p class="xsmall text-muted mb-0">Cargando colección...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL FAVORITAS: SELECCIONAR -->
  <div class="modal fade" id="favoriteSelectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content profile-modal">
        <div class="modal-header border-0">
          <h5 class="modal-title h6">
            <i class="bi bi-heart me-1"></i>Elegir cartas favoritas
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-md-5">
              <div class="input-group input-group-sm">
                <span class="input-group-text xsmall"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control form-control-sm xsmall" id="favoriteSearchName"
                  placeholder="Nombre o set">
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select form-select-sm xsmall" id="favoriteSearchRarity">
                <option value="all">Rareza: Todas</option>
                <option value="common">Común</option>
                <option value="uncommon">Infrecuente</option>
                <option value="rare">Rara</option>
                <option value="superrare">Super rara</option>
                <option value="elite">Élite</option>
                <option value="epic">Épica</option>
                <option value="mythic">Mítica</option>
                <option value="legendary">Legendaria</option>
              </select>
            </div>
            <div
              class="col-md-3 xsmall text-muted d-flex align-items-center justify-content-end">
              <span id="favoriteSelectorCount">0 resultados</span>
            </div>
          </div>
          <div class="row g-2" id="favoriteCollectionGrid">
            <p class="xsmall text-muted mb-0">Cargando tus cartas...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE VENTA -->
  <div class="modal fade" id="saleDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content card-detail-modal">
        <div class="card-detail-glow"></div>
        <div class="card-detail-rays"></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4 text-center">
              <div class="card-detail-frame">
                <img id="saleDetailImage" src="" alt="Carta" class="card-detail-image">
              </div>
              <div class="mt-2">
                <span class="badge xsmall" id="saleDetailRarity"></span>
                <span class="badge bg-dark-subtle text-light-emphasis xsmall ms-1" id="saleDetailHolo"
                  style="display:none;">Holo</span>
              </div>
            </div>
            <div class="col-md-8">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <h2 class="h5 fw-bold mb-0" id="saleDetailName">Nombre carta</h2>
                <span class="xsmall text-muted" id="saleDetailId"></span>
              </div>
              <p class="xsmall text-muted mb-2" id="saleDetailSet">Set</p>

              <div class="row g-2 mb-2">
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Precio de venta</span>
                    <div class="small fw-semibold" id="saleDetailPrice">-</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Fecha obtención</span>
                    <div class="small fw-semibold" id="saleDetailObtained">-</div>
                  </div>
                </div>
              </div>

              <div class="card-detail-meta xsmall mb-2">
                <i class="bi bi-info-circle me-1"></i>
                <span id="saleDetailMeta"></span>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="xsmall text-muted" id="saleDetailIndexInfo"></span>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-danger btn-sm" id="saleDetailRemoveBtn">
                    Quitar de venta
                  </button>
                  <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                    Cerrar
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE FAVORITA -->
  <div class="modal fade" id="favoriteDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content card-detail-modal">
        <div class="card-detail-glow"></div>
        <div class="card-detail-rays"></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4 text-center">
              <div class="card-detail-frame">
                <img id="favDetailImage" src="" alt="Carta" class="card-detail-image">
              </div>
              <div class="mt-2">
                <span class="badge xsmall" id="favDetailRarity"></span>
                <span class="badge bg-dark-subtle text-light-emphasis xsmall ms-1" id="favDetailHolo"
                  style="display:none;">Holo</span>
              </div>
            </div>
            <div class="col-md-8">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <h2 class="h5 fw-bold mb-0" id="favDetailName">Nombre carta</h2>
                <span class="xsmall text-muted" id="favDetailId"></span>
              </div>
              <p class="xsmall text-muted mb-2" id="favDetailSet">Set</p>

              <div class="row g-2 mb-2">
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Tipo</span>
                    <div class="small fw-semibold" id="favDetailTypes">-</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Fecha obtención</span>
                    <div class="small fw-semibold" id="favDetailObtained">-</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Precio estimado</span>
                    <div class="small fw-semibold" id="favDetailPrice">-</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card-detail-stat">
                    <span class="xsmall text-muted text-uppercase">Propietarios globales</span>
                    <div class="small fw-semibold" id="favDetailOwners">-</div>
                  </div>
                </div>
              </div>

              <div class="card-detail-meta xsmall mb-2">
                <i class="bi bi-info-circle me-1"></i>
                <span id="favDetailMeta"></span>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="xsmall text-muted" id="favDetailIndexInfo"></span>
                <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                  Cerrar
                </button>
              </div>

              <div class="d-flex justify-content-end mt-2">
                <button
                  class="btn btn-sm btn-favorite-heart position-relative d-inline-flex align-items-center gap-1"
                  type="button" id="favDetailHeartBtn">
                  <i class="bi bi-heart-fill heart-normal"></i>
                  <i class="bi bi-heartbreak-fill heart-broken"></i>
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OFFCANVAS COMPARTIR PERFIL -->
  <div class="offcanvas offcanvas-bottom offcanvas-share" tabindex="-1" id="shareProfileSheet"
    aria-labelledby="shareProfileSheetLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title xsmall text-uppercase text-muted" id="shareProfileSheetLabel">
        Compartir perfil
      </h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
        aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-2 small">
        Comparte tu perfil de entrenador con tus amigos:
      </div>
      <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-light btn-sm share-chip" type="button" id="btnShareInstagram">
          <i class="bi bi-instagram me-1 text-danger"></i>Instagram
        </button>
        <button class="btn btn-light btn-sm share-chip" type="button" id="btnShareWhatsApp">
          <i class="bi bi-whatsapp me-1 text-success"></i>WhatsApp
        </button>
        <button class="btn btn-light btn-sm share-chip" type="button" id="btnShareTwitter">
          <i class="bi bi-twitter-x me-1"></i>X (Twitter)
        </button>
        <button class="btn btn-light btn-sm share-chip" type="button" id="btnShareCopyLink">
          <i class="bi bi-link-45deg me-1"></i>Copiar enlace
        </button>
      </div>
      <div class="input-group input-group-sm">
        <span class="input-group-text xsmall"><i class="bi bi-person"></i></span>
        <input type="text" class="form-control form-control-sm xsmall" id="shareProfileUrl" readonly>
        <button class="btn btn-outline-secondary btn-sm xsmall" type="button" id="btnShareCopyInline">
          Copiar
        </button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script perfil -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DATOS USUARIO ---
      const defaultName = 'Entrenador';
      const defaultEmail = 'entrenador@pokemarket.com';
      const defaultAvatar = 'img/avatars/pokeball.png';
      const defaultBio = 'Coleccionista de cartas Pokémon, cazador de grails y adicto a las ruletas legendarias.';

      const name = localStorage.getItem('pm_user_name') || defaultName;
      const email = localStorage.getItem('pm_user_email') || defaultEmail;
      const avatar = localStorage.getItem('pm_user_avatar') || defaultAvatar;
      const bio = localStorage.getItem('pm_user_bio') || defaultBio;

      // Navbar
      const navbarUserName = document.getElementById('navbarUserName');
      const dropdownUserName = document.getElementById('dropdownUserName');
      const dropdownUserEmail = document.getElementById('dropdownUserEmail');
      const navbarAvatar = document.getElementById('navbarAvatar');
      const dropdownAvatar = document.getElementById('dropdownAvatar');

      if (navbarUserName) navbarUserName.textContent = name;
      if (dropdownUserName) dropdownUserName.textContent = name;
      if (dropdownUserEmail) dropdownUserEmail.textContent = email;
      if (navbarAvatar) navbarAvatar.src = avatar;
      if (dropdownAvatar) dropdownAvatar.src = avatar;

      const credits = localStorage.getItem('pm_credits') || '0';
      const navbarCredits = document.getElementById('navbarCredits');
      if (navbarCredits) navbarCredits.textContent = credits;

      // Cabecera perfil
      const profileName = document.getElementById('profileName');
      const profileEmail = document.getElementById('profileEmail');
      const profileAvatar = document.getElementById('profileAvatar');
      const profileBio = document.getElementById('profileBio');

      if (profileName) profileName.textContent = name;
      if (profileEmail) profileEmail.textContent = email;
      if (profileAvatar) profileAvatar.src = avatar;
      if (profileBio) profileBio.textContent = bio;

      // Handler estilo @user
      const handlerBadge = document.querySelector('.bg-poke-username');
      if (handlerBadge) {
        const base = email.split('@')[0] || 'entrenador';
        handlerBadge.textContent = '@' + base;
      }

      // --- LOGOUT ---
      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', () => {
          localStorage.removeItem('pm_user_name');
          localStorage.removeItem('pm_user_email');
          localStorage.removeItem('pm_user_avatar');
          localStorage.removeItem('pm_user_bio');
          localStorage.removeItem('pm_cards_sale');
          localStorage.removeItem('pm_collection');
          localStorage.removeItem('pm_credits');
        });
      }

      // --- EDITAR PERFIL (MODAL) ---
      const editarNombre = document.getElementById('editarNombre');
      const editarEmail = document.getElementById('editarEmail');
      const editarBio = document.getElementById('editarBio');
      const editarAvatarPreview = document.getElementById('editarAvatarPreview');
      const editarAvatarInput = document.getElementById('editarAvatarInput');
      const btnGuardarPerfil = document.getElementById('btnGuardarPerfil');

      if (editarNombre) editarNombre.value = name;
      if (editarEmail) editarEmail.value = email;
      if (editarBio) editarBio.value = bio;
      if (editarAvatarPreview) editarAvatarPreview.src = avatar;

      // Previsualizar avatar galería
      if (editarAvatarInput) {
        editarAvatarInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            const dataUrl = ev.target.result;
            if (editarAvatarPreview) editarAvatarPreview.src = dataUrl;
          };
          reader.readAsDataURL(file);
        });
      }

      // Seleccionar avatar predeterminado
      const avatarDefaultOptions = document.querySelectorAll('[data-avatar-default]');
      avatarDefaultOptions.forEach(img => {
        img.addEventListener('click', () => {
          const selectedUrl = img.getAttribute('data-avatar-default');
          if (!selectedUrl) return;
          avatarDefaultOptions.forEach(i => i.classList.remove('selected'));
          img.classList.add('selected');
          if (editarAvatarPreview) editarAvatarPreview.src = selectedUrl;
        });
      });

      // Guardar cambios perfil
      if (btnGuardarPerfil) {
        btnGuardarPerfil.addEventListener('click', () => {
          const form = document.getElementById('formEditarPerfil');
          if (form && !form.checkValidity()) {
            form.classList.add('was-validated');
            return;
          }

          const nuevoNombre = editarNombre ? editarNombre.value.trim() : name;
          const nuevoEmail = editarEmail ? editarEmail.value.trim() : email;
          const nuevaBio = editarBio ? editarBio.value.trim() : bio;
          let nuevoAvatar = avatar;

          if (editarAvatarPreview && editarAvatarPreview.src) {
            nuevoAvatar = editarAvatarPreview.src;
          }

          localStorage.setItem('pm_user_name', nuevoNombre || defaultName);
          localStorage.setItem('pm_user_email', nuevoEmail || defaultEmail);
          localStorage.setItem('pm_user_bio', nuevaBio || defaultBio);
          localStorage.setItem('pm_user_avatar', nuevoAvatar || defaultAvatar);

          if (navbarUserName) navbarUserName.textContent = nuevoNombre || defaultName;
          if (dropdownUserName) dropdownUserName.textContent = nuevoNombre || defaultName;
          if (dropdownUserEmail) dropdownUserEmail.textContent = nuevoEmail || defaultEmail;
          if (navbarAvatar) navbarAvatar.src = nuevoAvatar || defaultAvatar;
          if (dropdownAvatar) dropdownAvatar.src = nuevoAvatar || defaultAvatar;
          if (profileName) profileName.textContent = nuevoNombre || defaultName;
          if (profileEmail) profileEmail.textContent = nuevoEmail || defaultEmail;
          if (profileAvatar) profileAvatar.src = nuevoAvatar || defaultAvatar;
          if (profileBio) profileBio.textContent = nuevaBio || defaultBio;
          if (handlerBadge) {
            const base = (nuevoEmail || defaultEmail).split('@')[0] || 'entrenador';
            handlerBadge.textContent = '@' + base;
          }

          const modalEl = document.getElementById('editarPerfilModal');
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          modalInstance.hide();
        });
      }

      // --- COLECCIÓN GLOBAL ---
      let collection = [];
      const rarityLabels = {
        common: 'Común',
        uncommon: 'Infrecuente',
        rare: 'Rara',
        superrare: 'Super rara',
        elite: 'Élite',
        epic: 'Épica',
        mythic: 'Mítica',
        legendary: 'Legendaria'
      };

      function loadCollection() {
        const raw = localStorage.getItem('pm_collection') || '[]';
        try {
          const data = JSON.parse(raw);
          collection = Array.isArray(data) ? data.map((c, idx) => ({ ...c, _idx: idx })) : [];
        } catch {
          collection = [];
        }
      }

      loadCollection();

      function rarityKey(card) {
        return card.rarityInternal || 'common';
      }
      function rarityBadgeClass(card) {
        return 'badge rarity-' + (card.rarityInternal || 'common');
      }
      function rarityLabel(card) {
        const key = card.rarityInternal || 'common';
        return card.rarityLabel || rarityLabels[key] || key;
      }
      function cardPriceText(card) {
        const price = card.priceEur ?? card.priceUsd ?? null;
        if (price === null) return '-';
        return card.priceEur ? card.priceEur.toFixed(2) + ' €' : card.priceUsd.toFixed(2) + ' $';
      }
      function formatDate(iso) {
        if (!iso) return '-';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return '-';
        return d.toLocaleString('es-ES', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });
      }
      function estimateOwners(card) {
        const basePrice = card.priceEur ?? card.priceUsd ?? 0;
        if (!basePrice || basePrice <= 0) return '≈ 50 000';
        if (basePrice < 1) return '≈ 40 000';
        if (basePrice < 2) return '≈ 25 000';
        if (basePrice < 5) return '≈ 15 000';
        if (basePrice < 10) return '≈ 7 500';
        if (basePrice < 20) return '≈ 3 000';
        if (basePrice < 40) return '≈ 1 200';
        if (basePrice < 80) return '≈ 600';
        if (basePrice < 150) return '≈ 300';
        if (basePrice < 300) return '≈ 120';
        if (basePrice < 600) return '≈ 60';
        return '≈ 25';
      }

      // --- ESTADO EN VENTA ---
      let sales = [];
      function loadSales() {
        const raw = localStorage.getItem('pm_cards_sale') || '[]';
        try {
          const data = JSON.parse(raw);
          sales = Array.isArray(data) ? data : [];
        } catch {
          sales = [];
        }
      }
      function saveSales() {
        localStorage.setItem('pm_cards_sale', JSON.stringify(sales));
      }

      loadSales();

      const gridCartasVenta = document.getElementById('gridCartasVenta');
      const plantillaCartaVenta = document.getElementById('plantillaCartaVenta');
      const textoSinCartasVenta = document.getElementById('textoSinCartasVenta');
      const statCartasVenta = document.getElementById('statCartasVenta');

      function renderSales() {
        if (!gridCartasVenta || !plantillaCartaVenta) return;
        gridCartasVenta.querySelectorAll('.col-6, .col-md-4, .col-lg-3').forEach(col => {
          if (col.id !== 'plantillaCartaVenta') col.remove();
        });

        if (!sales.length) {
          if (textoSinCartasVenta) textoSinCartasVenta.style.display = 'block';
          if (statCartasVenta) statCartasVenta.textContent = '0';
          return;
        }
        if (textoSinCartasVenta) textoSinCartasVenta.style.display = 'none';
        if (statCartasVenta) statCartasVenta.textContent = String(sales.length);

        sales.forEach((sale, index) => {
          const col = plantillaCartaVenta.cloneNode(true);
          col.id = '';
          col.classList.remove('d-none');

          const art = col.querySelector('.card-perfil-venta');
          const frame = col.querySelector('.card-carta-frame');
          const nombreEl = col.querySelector('.carta-nombre');
          const rarezaBadge = col.querySelector('.carta-rareza-badge');
          const rarezaText = col.querySelector('.carta-rareza');
          const precioEl = col.querySelector('.carta-precio');
          const obtenidaEl = col.querySelector('.carta-obtenida');

          if (frame) {
            frame.innerHTML = '';
            const img = document.createElement('img');
            img.src = sale.image || 'img/avatars/pokeball.png';
            img.alt = sale.name || '';
            img.className = 'carta-img-real';
            frame.appendChild(img);
          }
          if (nombreEl) nombreEl.textContent = sale.name || 'Carta sin nombre';
          if (rarezaBadge) {
            rarezaBadge.textContent = rarityLabel(sale)[0] || 'R';
            rarezaBadge.className = 'badge xsmall carta-rareza-badge ' + rarityBadgeClass(sale);
          }
          if (rarezaText) rarezaText.textContent = rarityLabel(sale);
          if (precioEl) precioEl.textContent = sale.price || cardPriceText(sale) || '-';
          if (obtenidaEl) obtenidaEl.textContent = sale.obtainedAt ? formatDate(sale.obtainedAt) : '-';

          if (art) {
            art.addEventListener('click', () => openSaleDetail(index));
          }

          gridCartasVenta.appendChild(col);
        });
      }

      // DETALLE VENTA
      const saleDetailModalEl = document.getElementById('saleDetailModal');
      const saleDetailImage = document.getElementById('saleDetailImage');
      const saleDetailRarity = document.getElementById('saleDetailRarity');
      const saleDetailHolo = document.getElementById('saleDetailHolo');
      const saleDetailName = document.getElementById('saleDetailName');
      const saleDetailId = document.getElementById('saleDetailId');
      const saleDetailSet = document.getElementById('saleDetailSet');
      const saleDetailPrice = document.getElementById('saleDetailPrice');
      const saleDetailObtained = document.getElementById('saleDetailObtained');
      const saleDetailMeta = document.getElementById('saleDetailMeta');
      const saleDetailIndexInfo = document.getElementById('saleDetailIndexInfo');
      const saleDetailRemoveBtn = document.getElementById('saleDetailRemoveBtn');
      let saleDetailModalInstance = saleDetailModalEl ? new bootstrap.Modal(saleDetailModalEl) : null;
      let currentSaleIndex = null;

      function openSaleDetail(index) {
        const sale = sales[index];
        if (!sale || !saleDetailModalInstance) return;
        currentSaleIndex = index;

        if (saleDetailImage) saleDetailImage.src = sale.image || 'img/avatars/pokeball.png';
        if (saleDetailName) saleDetailName.textContent = sale.name || 'Carta sin nombre';
        if (saleDetailId) saleDetailId.textContent = sale.id || '';
        if (saleDetailSet) saleDetailSet.textContent = sale.setName || '';
        if (saleDetailPrice) saleDetailPrice.textContent = sale.price || cardPriceText(sale) || '-';
        if (saleDetailObtained) saleDetailObtained.textContent = sale.obtainedAt ? formatDate(sale.obtainedAt) : '-';

        if (saleDetailRarity) {
          saleDetailRarity.textContent = rarityLabel(sale);
          saleDetailRarity.className = 'badge xsmall ' + rarityBadgeClass(sale);
        }
        if (saleDetailHolo) {
          saleDetailHolo.style.display = sale.holographic ? 'inline-block' : 'none';
        }

        if (saleDetailMeta) {
          const basePrice = cardPriceText(sale);
          const owners = estimateOwners(sale);
          saleDetailMeta.textContent = `Esta carta se estima en ${basePrice || '-'} y se calcula que hay ${owners} copias en manos de jugadores.`;
        }

        if (saleDetailIndexInfo) {
          saleDetailIndexInfo.textContent = `Carta ${index + 1} de ${sales.length} en tu lista de venta.`;
        }

        saleDetailModalInstance.show();
      }

      if (saleDetailRemoveBtn) {
        saleDetailRemoveBtn.addEventListener('click', () => {
          if (currentSaleIndex === null) return;
          sales.splice(currentSaleIndex, 1);
          saveSales();
          renderSales();
          if (saleDetailModalInstance) saleDetailModalInstance.hide();
        });
      }

      // --- FAVORITAS ---
      let favorites = [];
      function loadFavorites() {
        const raw = localStorage.getItem('pm_favorites') || '[]';
        try {
          const data = JSON.parse(raw);
          favorites = Array.isArray(data) ? data : [];
        } catch {
          favorites = [];
        }
      }
      function saveFavorites() {
        localStorage.setItem('pm_favorites', JSON.stringify(favorites));
      }

      loadFavorites();

      const gridFavoritas = document.getElementById('gridFavoritas');
      const textoSinFavoritas = document.getElementById('textoSinFavoritas');

      function renderFavorites() {
        if (!gridFavoritas) return;
        gridFavoritas.querySelectorAll('.col-6, .col-md-4, .col-lg-3').forEach(col => col.remove());

        if (!favorites.length) {
          if (textoSinFavoritas) textoSinFavoritas.style.display = 'block';
          return;
        }
        if (textoSinFavoritas) textoSinFavoritas.style.display = 'none';

        favorites.forEach((fav, index) => {
          const col = document.createElement('div');
          col.className = 'col-6 col-md-4 col-lg-3';
          col.innerHTML = `
        <article class="card card-carta h-100 card-perfil-favorita card-perfil-venta-clickable">
          <div class="card-carta-frame">
            <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
              <img src="${fav.image || 'img/avatars/pokeball.png'}" alt="${fav.name || ''}" class="carta-img-real">
            </div>
          </div>
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h3 class="card-title mb-0 small text-truncate">${fav.name || 'Carta sin nombre'}</h3>
              <span class="badge xsmall ${rarityBadgeClass(fav)}">${rarityLabel(fav)}</span>
            </div>
            <p class="mb-1 xsmall text-muted text-truncate">${fav.setName || ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small fw-semibold">${cardPriceText(fav)}</span>
              <span class="xsmall text-muted">${fav.obtainedAt ? formatDate(fav.obtainedAt) : '-'}</span>
            </div>
          </div>
        </article>
      `;
          const art = col.querySelector('.card-perfil-favorita');
          if (art) {
            art.addEventListener('click', () => openFavoriteDetail(index));
          }
          gridFavoritas.appendChild(col);
        });
      }

      // DETALLE FAVORITA
      const favoriteDetailModalEl = document.getElementById('favoriteDetailModal');
      const favDetailImage = document.getElementById('favDetailImage');
      const favDetailRarity = document.getElementById('favDetailRarity');
      const favDetailHolo = document.getElementById('favDetailHolo');
      const favDetailName = document.getElementById('favDetailName');
      const favDetailId = document.getElementById('favDetailId');
      const favDetailSet = document.getElementById('favDetailSet');
      const favDetailTypes = document.getElementById('favDetailTypes');
      const favDetailObtained = document.getElementById('favDetailObtained');
      const favDetailPrice = document.getElementById('favDetailPrice');
      const favDetailOwners = document.getElementById('favDetailOwners');
      const favDetailMeta = document.getElementById('favDetailMeta');
      const favDetailIndexInfo = document.getElementById('favDetailIndexInfo');
      const favDetailHeartBtn = document.getElementById('favDetailHeartBtn');
      let favoriteDetailModalInstance = favoriteDetailModalEl ? new bootstrap.Modal(favoriteDetailModalEl) : null;
      let currentFavoriteIndex = null;

      function openFavoriteDetail(index) {
        const fav = favorites[index];
        if (!fav || !favoriteDetailModalInstance) return;
        currentFavoriteIndex = index;

        if (favDetailImage) favDetailImage.src = fav.image || 'img/avatars/pokeball.png';
        if (favDetailName) favDetailName.textContent = fav.name || 'Carta sin nombre';
        if (favDetailId) favDetailId.textContent = fav.id || '';
        if (favDetailSet) favDetailSet.textContent = fav.setName || '';

        if (favDetailTypes) {
          const types = fav.types && fav.types.length ? fav.types.join(' / ') : '—';
          favDetailTypes.textContent = types;
        }
        if (favDetailObtained) favDetailObtained.textContent = fav.obtainedAt ? formatDate(fav.obtainedAt) : '-';
        if (favDetailPrice) favDetailPrice.textContent = cardPriceText(fav);
        if (favDetailOwners) favDetailOwners.textContent = estimateOwners(fav);

        if (favDetailRarity) {
          favDetailRarity.textContent = rarityLabel(fav);
          favDetailRarity.className = 'badge xsmall ' + rarityBadgeClass(fav);
        }
        if (favDetailHolo) {
          favDetailHolo.style.display = fav.holographic ? 'inline-block' : 'none';
        }

        if (favDetailMeta) {
          favDetailMeta.textContent = 'Carta marcada como favorita solo para ti. No afecta a la colección global, pero sirve como acceso rápido a tus grails.';
        }
        if (favDetailIndexInfo) {
          favDetailIndexInfo.textContent = `Favorita ${index + 1} de ${favorites.length}.`;
        }

        favoriteDetailModalInstance.show();
      }

      if (favDetailHeartBtn) {
        favDetailHeartBtn.addEventListener('click', () => {
          if (currentFavoriteIndex === null) return;
          favorites.splice(currentFavoriteIndex, 1);
          saveFavorites();
          renderFavorites();
          if (favoriteDetailModalInstance) favoriteDetailModalInstance.hide();
        });
      }

      // --- SELECTOR DE VENTA / FAVORITAS (desde colección) ---
      const saleSearchName = document.getElementById('saleSearchName');
      const saleSearchRarity = document.getElementById('saleSearchRarity');
      const saleSelectorCount = document.getElementById('saleSelectorCount');
      const saleCollectionGrid = document.getElementById('saleCollectionGrid');

      const favoriteSearchName = document.getElementById('favoriteSearchName');
      const favoriteSearchRarity = document.getElementById('favoriteSearchRarity');
      const favoriteSelectorCount = document.getElementById('favoriteSelectorCount');
      const favoriteCollectionGrid = document.getElementById('favoriteCollectionGrid');

      function filterCollection(nameFilter, rarityFilter) {
        const term = (nameFilter || '').toLowerCase();
        return collection.filter(card => {
          const matchName = !term ||
            (card.name && card.name.toLowerCase().includes(term)) ||
            (card.setName && card.setName.toLowerCase().includes(term));
          const key = rarityKey(card);
          const matchRarity = rarityFilter === 'all' || rarityFilter === key;
          return matchName && matchRarity;
        });
      }

      function renderSaleSelector() {
        if (!saleCollectionGrid || !saleSelectorCount) return;
        const filtered = filterCollection(saleSearchName?.value, saleSearchRarity?.value);
        saleCollectionGrid.innerHTML = '';

        saleSelectorCount.textContent = `${filtered.length} resultados`;

        if (!filtered.length) {
          saleCollectionGrid.innerHTML = '<p class="xsmall text-muted mb-0">No se han encontrado cartas.</p>';
          return;
        }

        filtered.forEach(card => {
          const col = document.createElement('div');
          col.className = 'col-6 col-md-4 col-lg-3';
          col.innerHTML = `
        <article class="card card-carta h-100 card-select-venta" data-card-idx="${card._idx}">
          <div class="card-carta-frame">
            <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
              <img src="${card.image || 'img/avatars/pokeball.png'}"
                   alt="${card.name || ''}"
                   class="carta-img-real">
            </div>
          </div>
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h3 class="card-title mb-0 small text-truncate">${card.name || 'Carta sin nombre'}</h3>
              <span class="${rarityBadgeClass(card)} xsmall">${rarityLabel(card)}</span>
            </div>
            <p class="mb-1 xsmall text-muted text-truncate">${card.setName || ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small fw-semibold">${cardPriceText(card)}</span>
              <span class="xsmall text-muted">${card.obtainedAt ? formatDate(card.obtainedAt) : '-'}</span>
            </div>
          </div>
        </article>
      `;
          const art = col.querySelector('.card-select-venta');
          if (art) {
            art.addEventListener('click', () => {
              const idx = card._idx;
              const fromCollection = collection.find(c => c._idx === idx);
              if (!fromCollection) return;

              const precio = prompt('Precio de venta (ej: 25.00 €):', cardPriceText(fromCollection));
              sales.push({
                ...fromCollection,
                price: precio || cardPriceText(fromCollection)
              });
              saveSales();
              renderSales();
              const modalEl = document.getElementById('selectCollectionCardModal');
              const modalInstance = bootstrap.Modal.getInstance(modalEl);
              modalInstance.hide();
            });
          }
          saleCollectionGrid.appendChild(col);
        });
      }

      function renderFavoriteSelector() {
        if (!favoriteCollectionGrid || !favoriteSelectorCount) return;
        const filtered = filterCollection(favoriteSearchName?.value, favoriteSearchRarity?.value);
        favoriteCollectionGrid.innerHTML = '';

        favoriteSelectorCount.textContent = `${filtered.length} resultados`;

        if (!filtered.length) {
          favoriteCollectionGrid.innerHTML = '<p class="xsmall text-muted mb-0">No se han encontrado cartas.</p>';
          return;
        }

        filtered.forEach(card => {
          const col = document.createElement('div');
          col.className = 'col-6 col-md-4 col-lg-3';
          col.innerHTML = `
        <article class="card card-carta h-100 card-select-fav" data-card-idx="${card._idx}">
          <div class="card-carta-frame">
            <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
              <img src="${card.image || 'img/avatars/pokeball.png'}"
                   alt="${card.name || ''}"
                   class="carta-img-real">
            </div>
          </div>
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h3 class="card-title mb-0 small text-truncate">${card.name || 'Carta sin nombre'}</h3>
              <span class="${rarityBadgeClass(card)} xsmall">${rarityLabel(card)}</span>
            </div>
            <p class="mb-1 xsmall text-muted text-truncate">${card.setName || ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small fw-semibold">${cardPriceText(card)}</span>
              <span class="xsmall text-muted">${card.obtainedAt ? formatDate(card.obtainedAt) : '-'}</span>
            </div>
          </div>
        </article>
      `;
          const art = col.querySelector('.card-select-fav');
          if (art) {
            art.addEventListener('click', () => {
              const idx = card._idx;
              const fromCollection = collection.find(c => c._idx === idx);
              if (!fromCollection) return;

              if (!favorites.some(f => f.id === fromCollection.id)) {
                favorites.push(fromCollection);
                saveFavorites();
                renderFavorites();
              }

              const modalEl = document.getElementById('favoriteSelectModal');
              const modalInstance = bootstrap.Modal.getInstance(modalEl);
              modalInstance.hide();
            });
          }
          favoriteCollectionGrid.appendChild(col);
        });
      }

      if (saleSearchName) saleSearchName.addEventListener('input', renderSaleSelector);
      if (saleSearchRarity) saleSearchRarity.addEventListener('change', renderSaleSelector);

      if (favoriteSearchName) favoriteSearchName.addEventListener('input', renderFavoriteSelector);
      if (favoriteSearchRarity) favoriteSearchRarity.addEventListener('change', renderFavoriteSelector);

      // Buscador de cartas en perfil (filtra en venta + favoritas por nombre)
      const profileCardSearch = document.getElementById('profileCardSearch');
      if (profileCardSearch) {
        profileCardSearch.addEventListener('input', () => {
          const term = profileCardSearch.value.toLowerCase();

          document.querySelectorAll('#gridCartasVenta .card-perfil-venta').forEach(card => {
            const nameEl = card.querySelector('.carta-nombre');
            const txt = nameEl ? nameEl.textContent.toLowerCase() : '';
            card.closest('.col-6, .col-md-4, .col-lg-3').style.display =
              !term || txt.includes(term) ? '' : 'none';
          });

          document.querySelectorAll('#gridFavoritas .card-perfil-favorita').forEach(card => {
            const nameEl = card.querySelector('.card-title');
            const txt = nameEl ? nameEl.textContent.toLowerCase() : '';
            card.closest('.col-6, .col-md-4, .col-lg-3').style.display =
              !term || txt.includes(term) ? '' : 'none';
          });
        });
      }

      // Compartir perfil
      const shareProfileUrl = document.getElementById('shareProfileUrl');
      const btnShareCopyInline = document.getElementById('btnShareCopyInline');
      const btnShareCopyLink = document.getElementById('btnShareCopyLink');
      const btnShareInstagram = document.getElementById('btnShareInstagram');
      const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
      const btnShareTwitter = document.getElementById('btnShareTwitter');

      const currentProfileUrl = window.location.href;
      if (shareProfileUrl) shareProfileUrl.value = currentProfileUrl;

      function copyProfileLink() {
        if (!navigator.clipboard) {
          const input = shareProfileUrl;
          if (!input) return;
          input.select();
          document.execCommand('copy');
          return;
        }
        navigator.clipboard.writeText(currentProfileUrl);
      }

      if (btnShareCopyInline) btnShareCopyInline.addEventListener('click', copyProfileLink);
      if (btnShareCopyLink) btnShareCopyLink.addEventListener('click', copyProfileLink);

      if (btnShareInstagram) {
        btnShareInstagram.addEventListener('click', () => {
          copyProfileLink();
          alert('En Instagram tendrás que pegar el enlace manualmente en tu bio o story.');
        });
      }
      if (btnShareWhatsApp) {
        btnShareWhatsApp.addEventListener('click', () => {
          const text = encodeURIComponent(`Mira mi perfil en PokeMarket: ${currentProfileUrl}`);
          window.open(`https://wa.me/?text=${text}`, '_blank');
        });
      }
      if (btnShareTwitter) {
        btnShareTwitter.addEventListener('click', () => {
          const text = encodeURIComponent('Mi perfil de PokeMarket');
          const url = encodeURIComponent(currentProfileUrl);
          window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        });
      }

      // Inicializar secciones
      renderSales();
      renderFavorites();
      renderSaleSelector();
      renderFavoriteSelector();
    });
  </script>

</body>
</html>